<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GainX Wallet - Professional Black Theme with Swap</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #000; /* Base background is black */
      color: #e5e7eb; /* Default light text color */
    }

    /* Modal Styles adapted for black theme */
    .modal {
      display: none;
      position: fixed;
      z-index: 50;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.75);
      font-family: 'Inter', sans-serif;
    }

    .modal-content {
      background-color: #111827;
      color: #e5e7eb;
      margin: 8% auto;
      padding: 25px;
      border: 1px solid #374151;
      width: 90%;
      max-width: 500px;
      border-radius: 10px;
      position: relative;
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    }

    .modal-content h2 {
        margin-top: 0;
        font-size: 1.5rem;
        font-weight: 600;
        color: #f3f4f6;
        text-align: center;
        margin-bottom: 24px;
    }
    .modal-content h4 { /* Used for sub-sections in modals */
        font-size: 1.125rem;
        font-weight: 600;
        margin-top: 20px;
        margin-bottom: 12px;
        color: #d1d5db;
        border-bottom: 1px solid #374151;
        padding-bottom: 8px;
    }

    .close-button {
      color: #9ca3af;
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 28px;
      font-weight: bold;
      line-height: 1;
    }

    .close-button:hover,
    .close-button:focus {
      color: #f3f4f6;
      text-decoration: none;
      cursor: pointer;
    }

    /* Styles for Withdrawal and Swap Modals */
    .options-group { /* For withdrawal options / swap direction */
      margin-bottom: 25px;
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .option-btn { /* Generic button for options */
      padding: 10px 18px;
      border: 1px solid #374151;
      background-color: #1f2937;
      color: #e5e7eb;
      cursor: pointer;
      border-radius: 6px;
      font-size: 0.95em;
      font-weight: 500;
      transition: background-color 0.2s, border-color 0.2s, color 0.2s;
    }
    .option-btn:hover {
        background-color: #374151;
        border-color: #4b5563;
    }

    .option-btn.active {
      background-color: #0ea5e9;
      color: white;
      border-color: #0ea5e9;
    }
    .option-btn.active:hover {
      background-color: #0284c7;
    }

    .form-section label {
      display: block;
      margin-top: 16px;
      margin-bottom: 8px;
      font-weight: 500;
      color: #d1d5db;
      font-size: 0.9rem;
    }

    .form-section input[type="text"],
    .form-section input[type="number"],
    .form-section select { /* Added select here */
      width: 100%;
      padding: 12px;
      margin-bottom: 16px;
      border: 1px solid #374151;
      background-color: #1f2937;
      color: #e5e7eb;
      border-radius: 6px;
      box-sizing: border-box;
      font-size: 0.95em;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
     .form-section input[type="text"]:focus,
    .form-section input[type="number"]:focus,
    .form-section select:focus { /* Added select here */
        border-color: #0ea5e9;
        outline: none;
        box-shadow: 0 0 0 2px rgba(14,165,233,0.3);
    }
    /* Specific style for currency selector to make it less wide if needed */
    #currencySelector {
        padding: 8px 12px; /* Adjusted padding */
        font-size: 0.9em;
        margin-bottom: 0; /* No bottom margin if it's inline */
        width: auto; /* Allow it to size based on content */
        min-width: 100px; /* Minimum width */
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
    }


    .form-section button[type="button"], .form-section button[type="submit"] { /* Target specific buttons */
      background-color: #10b981;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      margin-top: 20px;
      width: 100%;
      transition: background-color 0.2s;
    }

    .form-section button[type="button"]:hover, .form-section button[type="submit"]:hover {
      background-color: #059669;
    }
    .form-section button[type="button"]:disabled, .form-section button[type="submit"]:disabled {
        background-color: #4b5563;
        color: #9ca3af;
        cursor: not-allowed;
    }

    .info-text {
        font-size: 0.875rem;
        color: #9ca3af; /* gray-400 */
        margin-top: -10px;
        margin-bottom: 16px;
    }
     .rate-display {
        font-size: 0.9rem;
        color: #60a5fa; /* blue-400 */
        text-align: center;
        margin-top: 10px;
        margin-bottom: 20px;
        padding: 8px;
        background-color: #1f2937; /* bg-gray-800 */
        border-radius: 4px;
    }


    .transaction-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #1f2937;
        cursor: pointer; /* Make items clickable */
        transition: background-color 0.1s;
    }
    .transaction-item:hover {
        background-color: #1f2937; /* Slight hover effect */
    }
    .transaction-item:last-child {
        border-bottom: none;
    }
    .transaction-details p:first-child {
        font-weight: 500;
    }
    .tx-type-deposit { color: #22c55e; }
    .tx-type-withdrawal { color: #ef4444; }
    .tx-type-swap { color: #a855f7; } /* purple-500 for swaps */
    .tx-status-pending { color: #eab308; }
    .tx-status-completed { color: #22c55e; }
    .tx-status-failed { color: #ef4444; }

    /* Transaction Detail Modal Styles */
    #transactionDetailModal .modal-content {
        max-width: 550px; /* Slightly wider for details */
    }
    .detail-grid {
        display: grid;
        grid-template-columns: auto 1fr; /* Label and value */
        gap: 8px 16px; /* Row and column gap */
        margin-bottom: 16px;
    }
    .detail-grid dt { /* Definition Term (Label) */
        font-weight: 500;
        color: #9ca3af; /* gray-400 */
        text-align: right;
    }
    .detail-grid dd { /* Definition Description (Value) */
        color: #e5e7eb; /* gray-200 */
        word-break: break-all; /* For long strings like addresses */
    }

    /* User Notice Banner Styles */
    #userNoticeBanner {
        display: none; /* Hidden by default */
        padding: 1rem;
        margin-bottom: 1.5rem;
        border-radius: 0.375rem; /* Tailwind rounded-md */
        font-weight: 500;
    }
    #userNoticeBanner.notice-info {
        background-color: #1e40af; /* blue-800 */
        color: #bfdbfe; /* blue-200 */
    }
    #userNoticeBanner.notice-critical {
        background-color: #b91c1c; /* red-700 */
        color: #fecaca; /* red-200 */
    }


    @media (max-width: 600px) {
      .modal-content {
        margin: 10% auto;
        width: 95%;
        padding: 20px;
      }
      .options-group {
        flex-direction: column;
      }
      .option-btn {
        width: 100%;
        margin-bottom: 10px;
      }
       .option-btn:last-child {
        margin-bottom: 0;
      }
      #currencySelector{
        width: 100%; /* Full width on mobile */
        margin-top: 8px;
      }
      .portfolio-header {
        flex-direction: column;
        align-items: center;
      }
      .detail-grid {
        grid-template-columns: 1fr; /* Stack label and value on mobile */
      }
      .detail-grid dt {
        text-align: left;
        margin-bottom: 2px;
        color: #6b7280; /* gray-500 */
      }
    }
  </style>
</head>
<body style="background-image: url('/images/mainbg.gif'); background-size: cover; background-repeat: no-repeat; background-attachment: fixed; background-color: #000;" class="min-h-screen flex flex-col items-center justify-start p-4 sm:p-6">
  <div id="userNoticeBanner"></div>
  <div id="app-container" class="w-full max-w-2xl space-y-8 mt-8 sm:mt-12">
    <header class="relative text-center mb-12"> <div class="inline-block mb-4 text-4xl font-bold text-sky-400">
        Gain<span class="text-gray-50">X</span>
      </div>
      <h1 id="main-header-title" class="text-3xl md:text-4xl font-semibold text-gray-100 mb-3">Loading IP Address...</h1>
      <p id="auth-status" class="text-sm text-gray-400">Connecting...</p>
      <p id="user-id-display" class="text-xs text-gray-500 mt-1">User ID: -</p>

      <div id="userMenuContainer" class="absolute top-0 right-0 mt-0 mr-0 sm:mt-2 sm:mr-2">
        <button id="userMenuToggleBtn" class="p-2 rounded-full hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-sky-500 hidden">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 text-gray-300 hover:text-sky-400">
            <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </button>
        <div id="userDropdownMenu" class="absolute right-0 mt-2 w-56 bg-gray-800 border border-gray-700 rounded-md shadow-xl py-1 z-[60] hidden"> <div class="px-4 py-3 border-b border-gray-700">
            <p class="text-xs text-gray-400 text-left">Signed in as</p>
            <p id="userMenuEmail" class="text-sm font-medium text-gray-100 truncate text-left">Loading...</p>
          </div>
          <nav class="py-1">
    <button id="helpMenuBtn" class="w-full text-left block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 hover:text-sky-300 transition-colors">
        Help
    </button>
    
    <a href="affiliate.html" class="w-full text-left block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 hover:text-sky-300 transition-colors">
        Affiliate Program
    </a>
    <button id="changePasswordMenuBtn" class="w-full text-left block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 hover:text-sky-300 transition-colors">
        Change Password
    </button>
    <button id="logoutMenuBtn" class="w-full text-left block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 hover:text-sky-300 transition-colors">
        Logout
    </button>
</nav>
        </div>
      </div>
    </header>

    <div id="wallet-section" class="bg-black shadow-xl rounded-lg p-6 border border-gray-800">
      <div class="mb-6 text-center">
        <div class="flex justify-center items-center gap-4 mb-2 portfolio-header">
            <h2 class="text-xl font-medium text-gray-300">Total Portfolio Value</h2>
            <select id="currencySelector" class="form-section bg-gray-800 border-gray-700 text-gray-200 rounded-md shadow-sm">
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
                <option value="JPY">JPY</option>
                <option value="GBP">GBP</option>
                <option value="INR">INR</option>
                <option value="CAD">CAD</option>
            </select>
        </div>
        <p id="total-portfolio-value-display" class="text-4xl font-bold text-cyan-400">
          <span class="animate-pulse">Loading...</span> <span id="portfolio-currency-code" class="text-2xl text-gray-400">USD</span>
        </p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="bg-gray-900 p-5 rounded-lg border border-gray-700 shadow-md">
          <h3 class="text-md font-medium text-gray-300 mb-2 flex items-center">USDT Balance</h3>
          <p id="usdt-balance-display" class="text-3xl font-semibold text-gray-100">
            <span class="animate-pulse">0.00</span> <img src="/images/usdt.png" alt="USDT" class="inline h-6 w-6 ml-1 align-middle" onerror="this.style.display='none'; this.outerHTML='USDT'">
          </p>
        </div>
        <div class="bg-gray-900 p-5 rounded-lg border border-gray-700 shadow-md">
          <h3 class="text-md font-medium text-gray-300 mb-2">ZSG Balance</h3>
          <p id="zsg-balance-display" class="text-3xl font-semibold text-gray-100">
             <span class="animate-pulse">0.00</span> <img src="/images/zsg.png" alt="ZSG" class="inline h-6 w-6 ml-1 align-middle" onerror="this.style.display='none'; this.outerHTML='ZSG'">
          </p>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-gray-900 p-5 rounded-lg border border-gray-700 shadow-md">
            <h3 class="text-md font-medium text-gray-300 mb-2">Current ROI</h3>
            <p id="current-roi-display" class="text-3xl font-semibold text-gray-100">
                <span class="animate-pulse">0.00%</span>
            </p>
        </div>
        <div class="bg-gray-900 p-5 rounded-lg border border-gray-700 shadow-md">
            <h3 class="text-md font-medium text-gray-300 mb-2">Plan</h3>
            <p id="plan-display" class="text-3xl font-semibold text-gray-100">
                <span class="animate-pulse">Loading...</span>
            </p>
        </div>
        <div class="bg-gray-900 p-5 rounded-lg border border-gray-700 shadow-md"> <h3 class="text-md font-medium text-gray-300 mb-2">Settlement Time</h3>
            <p id="settlement-time-display" class="text-2xl sm:text-3xl font-semibold text-gray-100">
                <span class="animate-pulse">Loading...</span>
            </p>
        </div>
      </div>

       <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
        <button id="topupFundsBtn" onclick="window.location.href='./deposit.html'" class="w-full px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-md font-semibold transition shadow-md hover:shadow-lg">Topup</button>
        <button type="button" id="openSwapModalBtn" class="w-full px-6 py-3 bg-sky-600 hover:bg-sky-700 text-white rounded-md font-semibold transition shadow-md hover:shadow-lg">Swap Tokens</button>
        <button type="button" id="openWithdrawModalGainxBtn" class="w-full px-6 py-3 bg-rose-600 hover:bg-rose-700 text-white rounded-md font-semibold transition shadow-md hover:shadow-lg">Withdraw</button>
      </div>
    </div>

    <div id="history-section" class="bg-black shadow-xl rounded-lg p-6 border border-gray-800">
      <h2 class="text-xl font-medium text-gray-100 mb-5">Transaction History</h2>
      <div id="transaction-history-list" class="space-y-1 max-h-60 overflow-y-auto pr-2">
        <p id="no-transactions-message" class="text-gray-500 p-4 text-center">Loading history...</p>
      </div>
    </div>

    <div id="swap-history-section" class="bg-black shadow-xl rounded-lg p-6 border border-gray-800">
      <h2 class="text-xl font-medium text-gray-100 mb-5">Swap History</h2>
      <div id="swap-history-list" class="space-y-1 max-h-60 overflow-y-auto pr-2">
        <p id="no-swaps-message" class="text-gray-500 p-4 text-center">Loading swap history...</p>
      </div>
    </div>
  </div>

  <div id="withdrawalModal" class="modal">
    <div class="modal-content">
      <span class="close-button" id="closeWithdrawModalBtn">&times;</span>
      <h2>Withdraw Funds</h2>
      <div class="options-group">
        <button id="selectImpsNeftBtn" class="option-btn active">IMPS/NEFT</button>
        <button id="selectUsdtTrc20Btn" class="option-btn">USDT-TRC20</button>
      </div>

      <div id="impsNeftForm" class="form-section">
        <h4>IMPS/NEFT Details</h4>
        <label for="withdrawalFullName">Full Name (as per bank records):</label>
        <input type="text" id="withdrawalFullName" name="withdrawalFullName" required>
        <label for="withdrawalIfscCode">IFSC Code:</label>
        <input type="text" id="withdrawalIfscCode" name="withdrawalIfscCode" required>
        <label for="withdrawalAccountNumber">Bank Account Number:</label>
        <input type="text" id="withdrawalAccountNumber" name="withdrawalAccountNumber" required>
        <label for="withdrawalImpsAmount">Amount (INR):</label>
        <input type="number" id="withdrawalImpsAmount" name="withdrawalImpsAmount" placeholder="e.g., 5000" required min="1">
        <button type="submit" id="submitImpsWithdrawalBtn">Submit IMPS/NEFT Withdrawal</button>
      </div>

      <div id="usdtTrc20Form" class="form-section" style="display: none;">
        <h4>USDT-TRC20 Details</h4>
         <label for="withdrawalUsdtAmount" id="withdrawalUsdtAmountLabel">Amount (USDT):</label>
        <input type="number" id="withdrawalUsdtAmount" name="withdrawalUsdtAmount" placeholder="e.g., 100" required min="1">
        <label for="withdrawalUsdtAddress">USDT Wallet Address (TRC20 Network):</label>
        <input type="text" id="withdrawalUsdtAddress" name="withdrawalUsdtAddress" placeholder="Starts with T..." required>
        <button type="submit" id="submitUsdtWithdrawalBtn">Submit USDT Withdrawal</button>
      </div>
    </div>
  </div>

  <div id="swapModal" class="modal">
    <div class="modal-content">
      <span class="close-button" id="closeSwapModalBtn">&times;</span>
      <h2>Swap Tokens (USDT to ZSG)</h2>
      <div class="form-section">
        <div class="flex items-center justify-center mb-6">
            <span id="swapFromLabel" class="mr-2 font-medium text-lg text-sky-400">USDT</span>
            <span class="mx-2 text-gray-400">&rarr;</span>
            <span id="swapToLabel" class="ml-2 font-medium text-lg text-emerald-400">ZSG</span>
        </div>

        <label for="swapAmountInput" id="swapAmountLabel">Amount to Swap (USDT):</label>
        <input type="number" id="swapAmountInput" name="swapAmountInput" placeholder="Enter amount" required min="0.000001">

        <p class="info-text" id="swapBalanceInfo">Your USDT Balance: <span id="swapUsdtBalance" class="font-medium">Loading...</span></p>

        <div id="swapRateDisplay" class="rate-display">Current Rate: Loading...</div>

        <label for="receiveAmountDisplay" id="receiveAmountLabel">You will receive (approx. ZSG):</label>
        <input type="text" id="receiveAmountDisplay" name="receiveAmountDisplay" readonly class="bg-gray-800 border-gray-700 cursor-not-allowed">

        <button type="button" id="confirmSwapBtn">Confirm Swap</button>
      </div>
    </div>
  </div>

  <div id="transactionDetailModal" class="modal">
    <div class="modal-content">
      <span class="close-button" id="closeTransactionDetailModalBtn">&times;</span>
      <h2 id="transactionDetailTitle">Transaction Details</h2>
      <div id="transactionDetailContent" class="mt-4">
        </div>
    </div>
  </div>

  <div id="message-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[70] hidden"> <div class="bg-gray-900 text-gray-100 p-6 sm:p-8 rounded-lg border border-gray-700 text-center shadow-2xl min-w-[300px] max-w-md">
      <p id="modal-message-text" class="mb-6 text-lg"></p>
      <button id="modal-close-button" class="px-6 py-2.5 bg-sky-600 hover:bg-sky-700 text-white rounded-md font-semibold transition-colors">Close</button>
    </div>
  </div>

  <footer class="w-full max-w-2xl mx-auto text-center py-8 mt-12 border-t border-gray-800">
    <p class="text-sm text-gray-500">&copy; 2024-2025 GainX by ZYRICCO. All Rights Reserved.</p>
    <p class="text-xs text-gray-600 mt-1">
        ZYRICCO Finance Ltd. 85 Bishopsgate, London EC2N 4AJ. Company Reg: #ZE-5082291
    </p>
    <div class="mt-3">
        <a href="legal.html#terms" class="text-xs text-gray-500 hover:text-sky-400 transition-colors mx-2">Terms</a>
        <span class="text-gray-600">&bull;</span>
        <a href="legal.html#privacy" class="text-xs text-gray-500 hover:text-sky-400 transition-colors mx-2">Privacy</a>
        <span class="text-gray-600">&bull;</span>
        <a href="mailto:support@gainx.ai" class="text-xs text-gray-500 hover:text-sky-400 transition-colors mx-2">Support</a>
    </div>
  </footer>


  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";
    import { getDatabase, ref, onValue, query, serverTimestamp, push, set, get, update } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC9yCEe4a9KC0Ph64gMkrDn_Cfah0TxlMw",
      authDomain: "swiftgain.firebaseapp.com",
      databaseURL: "https://swiftgain-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "swiftgain",
      storageBucket: "swiftgain.firebasestorage.app",
      messagingSenderId: "751911092919",
      appId: "1:751911092919:web:bd0ab90ca8b4432f0d4332"
    };

    let app;
    let auth;
    let database;
    let currentUserId = null;
    let currentZSGValue = 2.98; // Default ZSG value (USDT per ZSG)
    let INR_CONVERSION_RATE = 93.6; // Default INR conversion rate
    let currentUserData = null;
    let exchangeRates = null;
    let selectedDisplayCurrency = 'USD';
    let settlementCountdownIntervalWallet = null; // For this page's countdown

    // --- Icon Configuration ---
    const usdtIconRootPath = '/images/usdt.png';
    const zsgIconRootPath = '/images/zsg.png';

    const usdtIconLargeHtml = `<img src="${usdtIconRootPath}" alt="USDT" class="inline h-6 w-6 ml-1 align-middle" onerror="this.style.display='none'; this.outerHTML='USDT'">`;
    const usdtIconMediumHtml = `<img src="${usdtIconRootPath}" alt="USDT" class="inline h-5 w-5 ml-1 align-middle" onerror="this.style.display='none'; this.outerHTML='USDT'">`;
    const usdtIconSmallHtml = `<img src="${usdtIconRootPath}" alt="USDT" class="inline h-4 w-4 ml-1 align-middle" onerror="this.style.display='none'; this.outerHTML='USDT'">`;

    const zsgIconLargeHtml = `<img src="${zsgIconRootPath}" alt="ZSG" class="inline h-6 w-6 ml-1 align-middle" onerror="this.style.display='none'; this.outerHTML='ZSG'">`;
    const zsgIconMediumHtml = `<img src="${zsgIconRootPath}" alt="ZSG" class="inline h-5 w-5 ml-1 align-middle" onerror="this.style.display='none'; this.outerHTML='ZSG'">`;
    const zsgIconSmallHtml = `<img src="${zsgIconRootPath}" alt="ZSG" class="inline h-4 w-4 ml-1 align-middle" onerror="this.style.display='none'; this.outerHTML='ZSG'">`;


    function getUsdtIcon(size = 'medium') {
        if (size === 'large') return usdtIconLargeHtml;
        if (size === 'small') return usdtIconSmallHtml;
        return usdtIconMediumHtml;
    }

    function getZsgIcon(size = 'medium') {
        if (size === 'large') return zsgIconLargeHtml;
        if (size === 'small') return zsgIconSmallHtml;
        return zsgIconMediumHtml;
    }

    function getCurrencyDisplayHtml(currency, value, decimals = 2, iconSize = 'medium') {
        const formattedValue = (typeof value === 'number' && !isNaN(value)) ? value.toFixed(decimals) : (value || '0');
        if (currency === 'USDT') {
            return `${formattedValue} ${getUsdtIcon(iconSize)}`;
        }
        if (currency === 'ZSG') {
            return `${formattedValue} ${getZsgIcon(iconSize)}`;
        }
        return `${formattedValue} <span class="text-sm text-gray-400 ml-1">${currency}</span>`;
    }

    function getCurrencyLabelHtml(currency, iconSize = 'medium') {
        if (currency === 'USDT') {
            return getUsdtIcon(iconSize);
        }
        if (currency === 'ZSG') {
            return getZsgIcon(iconSize);
        }
        return currency;
    }
    // --- End Icon Configuration ---


    // Main UI Elements
    const mainHeaderTitleEl = document.getElementById('main-header-title');
    const totalPortfolioValueDisplayEl = document.getElementById('total-portfolio-value-display');
    const usdtBalanceDisplayEl = document.getElementById('usdt-balance-display');
    const zsgBalanceDisplayEl = document.getElementById('zsg-balance-display');
    const currencySelectorEl = document.getElementById('currencySelector');
    const portfolioCurrencyCodeEl = document.getElementById('portfolio-currency-code');
    const appContainerEl = document.getElementById('app-container');
    const userNoticeBannerEl = document.getElementById('userNoticeBanner');

    // New UI Elements for ROI, Plan, Settlement Time
    const currentRoiDisplayEl = document.getElementById('current-roi-display');
    const planDisplayEl = document.getElementById('plan-display');
    const settlementTimeDisplayEl = document.getElementById('settlement-time-display');

    // Button Elements
    const topupFundsBtnEl = document.getElementById('topupFundsBtn');
    const openSwapModalBtnEl = document.getElementById('openSwapModalBtn');
    const openWithdrawModalButtonEl = document.getElementById('openWithdrawModalGainxBtn');

    // Message Modal Elements
    const messageModalEl = document.getElementById("message-modal");
    const modalMessageTextEl = document.getElementById("modal-message-text");
    const modalCloseButtonEl = document.getElementById("modal-close-button");

    // Withdrawal Modal Elements
    const withdrawalModalEl = document.getElementById('withdrawalModal');
    const closeWithdrawModalBtnEl = document.getElementById('closeWithdrawModalBtn');
    const impsNeftFormEl = document.getElementById('impsNeftForm');
    const usdtTrc20FormEl = document.getElementById('usdtTrc20Form');
    const selectImpsNeftBtnEl = document.getElementById('selectImpsNeftBtn');
    const selectUsdtTrc20BtnEl = document.getElementById('selectUsdtTrc20Btn');
    const withdrawalFullNameInputEl = document.getElementById('withdrawalFullName');
    const withdrawalIfscCodeInputEl = document.getElementById('withdrawalIfscCode');
    const withdrawalAccountNumberInputEl = document.getElementById('withdrawalAccountNumber');
    const withdrawalImpsAmountInputEl = document.getElementById('withdrawalImpsAmount');
    const submitImpsWithdrawalBtnEl = document.getElementById('submitImpsWithdrawalBtn');
    const withdrawalUsdtAmountInputEl = document.getElementById('withdrawalUsdtAmount');
    const withdrawalUsdtAddressInputEl = document.getElementById('withdrawalUsdtAddress');
    const submitUsdtWithdrawalBtnEl = document.getElementById('submitUsdtWithdrawalBtn');
    const withdrawalUsdtAmountLabelEl = document.getElementById('withdrawalUsdtAmountLabel');


    // Swap Modal Elements
    const swapModalEl = document.getElementById('swapModal');
    const closeSwapModalBtnEl = document.getElementById('closeSwapModalBtn');
    const swapFromLabelEl = document.getElementById('swapFromLabel');
    const swapToLabelEl = document.getElementById('swapToLabel');
    const swapAmountInputEl = document.getElementById('swapAmountInput');
    const swapAmountLabelEl = document.getElementById('swapAmountLabel');
    const swapRateDisplayEl = document.getElementById('swapRateDisplay');
    const receiveAmountDisplayEl = document.getElementById('receiveAmountDisplay');
    const receiveAmountLabelEl = document.getElementById('receiveAmountLabel');
    const confirmSwapBtnEl = document.getElementById('confirmSwapBtn');
    const swapUsdtBalanceEl = document.getElementById('swapUsdtBalance');
    const swapBalanceInfoEl = document.getElementById('swapBalanceInfo');
    const isSwappingUsdtToZsg = true; // Hardcoded: Always USDT to ZSG

    // History Elements
    const transactionHistoryListEl = document.getElementById("transaction-history-list");
    const noTransactionsMessageEl = document.getElementById("no-transactions-message");
    const swapHistoryListEl = document.getElementById("swap-history-list");
    const noSwapsMessageEl = document.getElementById("no-swaps-message");

    // Transaction Detail Modal Elements
    const transactionDetailModalEl = document.getElementById('transactionDetailModal');
    const transactionDetailTitleEl = document.getElementById('transactionDetailTitle');
    const transactionDetailContentEl = document.getElementById('transactionDetailContent');
    const closeTransactionDetailModalBtnEl = document.getElementById('closeTransactionDetailModalBtn');

    // User Menu Elements
    const userMenuContainerEl = document.getElementById('userMenuContainer');
    const userMenuToggleBtnEl = document.getElementById('userMenuToggleBtn');
    const userDropdownMenuEl = document.getElementById('userDropdownMenu');
    const userMenuEmailEl = document.getElementById('userMenuEmail');
    const changePasswordMenuBtnEl = document.getElementById('changePasswordMenuBtn');
    const logoutMenuBtnEl = document.getElementById('logoutMenuBtn');
    const helpMenuBtnEl = document.getElementById('helpMenuBtn');

    // Event Listeners for Modals
    if (modalCloseButtonEl) {
        modalCloseButtonEl.addEventListener("click", () => {
          if(messageModalEl) messageModalEl.classList.add("hidden");
        });
    }
    if (closeTransactionDetailModalBtnEl) {
        closeTransactionDetailModalBtnEl.addEventListener("click", () => {
            if(transactionDetailModalEl) transactionDetailModalEl.style.display = "none";
        });
    }

    // Utility Functions
    function showGenericMessage(message, isError = false) {
        if (modalMessageTextEl && messageModalEl) {
            modalMessageTextEl.innerHTML = message; // Use innerHTML for icon compatibility
            modalMessageTextEl.className = `mb-6 text-lg font-medium ${isError ? "text-rose-400" : "text-emerald-400"}`;
            messageModalEl.classList.remove("hidden");
        } else {
            console.warn("Message modal elements not found. Falling back to console.");
            console.log(message); // Avoid alert
        }
    }

    function displayUserNotice(message, isCritical = false) {
        if (!userNoticeBannerEl) return;
        if (message && message.trim() !== '') {
            userNoticeBannerEl.textContent = message;
            userNoticeBannerEl.className = 'text-center p-4 mb-6 rounded-md font-medium';
            userNoticeBannerEl.classList.add(isCritical ? 'notice-critical' : 'notice-info');
            userNoticeBannerEl.style.display = 'block';
        } else {
            userNoticeBannerEl.style.display = 'none';
        }
    }

    async function fetchAndDisplayIpAddress() {
        if (!mainHeaderTitleEl) return;
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            mainHeaderTitleEl.textContent = `Your IP Address: ${data.ip}`;
        } catch (error) {
            console.error("Could not fetch IP address:", error);
            mainHeaderTitleEl.textContent = "IP Address Unavailable";
        }
    }

    async function fetchExchangeRates() {
        try {
            const response = await fetch('https://api.frankfurter.app/latest?from=USD');
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            const data = await response.json();
            exchangeRates = data.rates;
            exchangeRates['USD'] = 1;
            console.log("Exchange rates fetched:", exchangeRates);
            if (currentUserId) updateWalletData(currentUserId);
        } catch (error) {
            console.error("Could not fetch exchange rates:", error);
            if (totalPortfolioValueDisplayEl) {
                 totalPortfolioValueDisplayEl.innerHTML = `<span class="text-red-500 text-sm">Error loading rates.</span> <span class="text-2xl text-gray-400">${selectedDisplayCurrency}</span>`;
            }
        }
    }

    function setInitialLoadingState() {
        fetchAndDisplayIpAddress();
        fetchExchangeRates();
        if (totalPortfolioValueDisplayEl) totalPortfolioValueDisplayEl.innerHTML = `<span class="animate-pulse">Loading...</span> <span id="portfolio-currency-code" class="text-2xl text-gray-400">${selectedDisplayCurrency}</span>`;
        if (usdtBalanceDisplayEl) usdtBalanceDisplayEl.innerHTML = `<span class="animate-pulse">0.00</span> ${getUsdtIcon('large')}`;
        if (zsgBalanceDisplayEl) zsgBalanceDisplayEl.innerHTML = `<span class="animate-pulse">0.00</span> ${getZsgIcon('large')}`;
        if (currentRoiDisplayEl) currentRoiDisplayEl.innerHTML = `<span class="animate-pulse">0.00%</span>`;
        if (planDisplayEl) planDisplayEl.innerHTML = `<span class="animate-pulse">Loading...</span>`;
        if (settlementTimeDisplayEl) settlementTimeDisplayEl.innerHTML = `<span class="animate-pulse">Loading...</span>`;
        if (noTransactionsMessageEl) noTransactionsMessageEl.textContent = "Loading history...";
        if (noSwapsMessageEl) noSwapsMessageEl.textContent = "Loading swap history...";
        if (withdrawalUsdtAmountLabelEl) withdrawalUsdtAmountLabelEl.innerHTML = `Amount (${getCurrencyLabelHtml('USDT', 'medium')}):`;
    }
    setInitialLoadingState();

    // Firebase Initialization and Listeners
    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        database = getDatabase(app);
        console.log("Firebase initialized successfully for GainX Wallet page.");

        const zsgValueDbRef = ref(database, 'tokenInfo/currentValue');
        onValue(zsgValueDbRef, (snapshot) => {
            if (snapshot.exists() && typeof snapshot.val() === 'number' && snapshot.val() > 0) {
                currentZSGValue = snapshot.val();
                console.log("ZSG current value (USDT per ZSG) updated from Firebase to:", currentZSGValue);
                updateSwapModalRateDisplay();
                if (currentUserId) updateWalletData(currentUserId);
            } else {
                console.warn(`Using current/default ZSG value (${currentZSGValue}). Firebase value at 'tokenInfo/currentValue' not found or invalid.`);
            }
        }, (error) => console.error("Error fetching ZSG value. Using default. Error:", error));

        const inrRateDbRef = ref(database, 'globals/conversionRates/USDT_INR');
        onValue(inrRateDbRef, (snapshot) => {
            const newRate = snapshot.val();
            if (snapshot.exists() && typeof newRate === 'number' && newRate > 0) {
                if (INR_CONVERSION_RATE !== newRate) {
                    INR_CONVERSION_RATE = newRate;
                    console.log("INR_CONVERSION_RATE updated from Firebase to:", INR_CONVERSION_RATE);
                    if (currentUserId && selectedDisplayCurrency === 'INR') updateWalletData(currentUserId);
                }
            } else {
                console.warn(`Using current/default INR_CONVERSION_RATE (${INR_CONVERSION_RATE}). Firebase value not found or invalid.`);
            }
        }, (error) => console.error("Error fetching INR_CONVERSION_RATE. Using default. Error:", error));

    } catch (error) {
        console.error("Firebase initialization error:", error);
        if (appContainerEl) appContainerEl.innerHTML = '<div class="text-center p-10"><h1 class="text-2xl font-semibold text-red-500">Service Connection Error</h1><p class="text-gray-400 mt-2">Could not connect. Please try again later.</p></div>';
    }

    // --- Settlement Countdown Logic ---
    function updateSettlementCountdownDisplayWallet(targetTimestamp, displayElement) {
        if (!displayElement) return;

        if (settlementCountdownIntervalWallet) {
            clearInterval(settlementCountdownIntervalWallet);
            settlementCountdownIntervalWallet = null;
        }

        if (!targetTimestamp || typeof targetTimestamp !== 'number' || targetTimestamp <= Date.now()) {
            displayElement.textContent = (targetTimestamp && typeof targetTimestamp === 'number' && targetTimestamp <= Date.now()) ? "Settled" : "N/A";
            return;
        }

        const update = () => {
            const now = Date.now();
            const timeLeft = targetTimestamp - now;

            if (timeLeft <= 0) {
                displayElement.textContent = "Settled";
                clearInterval(settlementCountdownIntervalWallet);
                settlementCountdownIntervalWallet = null;
                return;
            }

            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

            displayElement.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
        };

        update(); // Initial call
        settlementCountdownIntervalWallet = setInterval(update, 1000);
    }


    // Wallet Data Update Function
    function updateWalletData(userId) {
      const userRef = ref(database, `users/${userId}`);
      onValue(userRef, (userDataSnapshot) => {
        if (userDataSnapshot.exists()) {
          currentUserData = userDataSnapshot.val();
          const usdtBalance = parseFloat(currentUserData.usdtBalance) || 0;
          const zsgTokenQty = parseFloat(currentUserData.zsgTokenBalance) || 0;
          const zsgHoldingsInUSDT = zsgTokenQty * currentZSGValue;

          if (currentUserData.isAccessBlocked) {
              if (appContainerEl) appContainerEl.style.display = 'none';
              displayUserNotice(currentUserData.blockReason || "Your account access has been temporarily suspended.", true);
              if(topupFundsBtnEl) topupFundsBtnEl.disabled = true;
              if(openSwapModalBtnEl) openSwapModalBtnEl.disabled = true;
              if(openWithdrawModalButtonEl) openWithdrawModalButtonEl.disabled = true;
              return;
          } else {
              if (appContainerEl) appContainerEl.style.display = 'block';
              if (currentUserData.userNotice && currentUserData.userNotice.trim() !== '') {
                  displayUserNotice(currentUserData.userNotice, false);
              } else {
                  if (userNoticeBannerEl) userNoticeBannerEl.style.display = 'none';
              }
          }

          if (openWithdrawModalButtonEl) {
            openWithdrawModalButtonEl.disabled = !!currentUserData.isWithdrawalBlocked;
            openWithdrawModalButtonEl.title = currentUserData.isWithdrawalBlocked ? "Withdrawals are currently blocked." : "";
            openWithdrawModalButtonEl.classList.toggle('opacity-50', !!currentUserData.isWithdrawalBlocked);
            openWithdrawModalButtonEl.classList.toggle('cursor-not-allowed', !!currentUserData.isWithdrawalBlocked);
          }
          if(topupFundsBtnEl) topupFundsBtnEl.disabled = false;
          if(openSwapModalBtnEl) {
            openSwapModalBtnEl.disabled = !!currentUserData.isWithdrawalBlocked;
            openSwapModalBtnEl.classList.toggle('opacity-50', !!currentUserData.isWithdrawalBlocked);
            openSwapModalBtnEl.classList.toggle('cursor-not-allowed', !!currentUserData.isWithdrawalBlocked);
          }

          let portfolioValueUSD = usdtBalance + zsgHoldingsInUSDT;
          let displayValue = portfolioValueUSD;
          let displayCurrency = 'USD';
          if (selectedDisplayCurrency === 'INR') {
              displayValue = portfolioValueUSD * INR_CONVERSION_RATE;
              displayCurrency = 'INR';
          } else if (selectedDisplayCurrency !== 'USD' && exchangeRates && exchangeRates[selectedDisplayCurrency]) {
              displayValue = portfolioValueUSD * exchangeRates[selectedDisplayCurrency];
              displayCurrency = selectedDisplayCurrency;
          } else if (selectedDisplayCurrency !== 'USD') {
              console.warn(`Rate for ${selectedDisplayCurrency} not available. Displaying in USD.`);
          }

          if (totalPortfolioValueDisplayEl) {
            const valSpan = totalPortfolioValueDisplayEl.childNodes[0];
            const codeSpan = document.getElementById('portfolio-currency-code');
            if (valSpan.nodeType === Node.TEXT_NODE || valSpan.tagName === 'SPAN') {
                valSpan.textContent = `${displayValue.toFixed(2)} `;
            } else {
                totalPortfolioValueDisplayEl.innerHTML = `${displayValue.toFixed(2)} <span id="portfolio-currency-code" class="text-2xl text-gray-400">${displayCurrency}</span>`;
            }
            if(codeSpan) codeSpan.textContent = displayCurrency;
          }

          if (zsgBalanceDisplayEl) zsgBalanceDisplayEl.innerHTML = getCurrencyDisplayHtml('ZSG', zsgTokenQty, 4, 'large');
          if (usdtBalanceDisplayEl) usdtBalanceDisplayEl.innerHTML = getCurrencyDisplayHtml('USDT', usdtBalance, 2, 'large');


          if (currentRoiDisplayEl) {
              const roi = currentUserData.currentROI;
              currentRoiDisplayEl.innerHTML = (typeof roi === 'number') ? `${roi.toFixed(2)}%` : '0.00%';
          }
          if (planDisplayEl) {
              planDisplayEl.textContent = currentUserData.planName || 'N/A';
          }
          if (settlementTimeDisplayEl) {
            const settlementTimestamp = currentUserData.settlementTime; // Expecting a numeric timestamp
            if (settlementTimestamp && typeof settlementTimestamp === 'number') {
                updateSettlementCountdownDisplayWallet(settlementTimestamp, settlementTimeDisplayEl);
            } else {
                settlementTimeDisplayEl.textContent = currentUserData.settlementTime || 'N/A'; // Fallback for non-timestamp or string
                if (settlementCountdownIntervalWallet) { // Clear interval if time is not valid for countdown
                    clearInterval(settlementCountdownIntervalWallet);
                    settlementCountdownIntervalWallet = null;
                }
            }
          }

          if (swapModalEl && swapModalEl.style.display === "block") updateSwapModalBalances();

        } else {
          currentUserData = null;
          console.log("No user data available for wallet:", userId);
          if (totalPortfolioValueDisplayEl) totalPortfolioValueDisplayEl.innerHTML = `0.00 <span id="portfolio-currency-code" class="text-2xl text-gray-400">${selectedDisplayCurrency}</span>`;
          if (zsgBalanceDisplayEl) zsgBalanceDisplayEl.innerHTML = getCurrencyDisplayHtml('ZSG', 0, 4, 'large');
          if (usdtBalanceDisplayEl) usdtBalanceDisplayEl.innerHTML = getCurrencyDisplayHtml('USDT', 0, 2, 'large');
          if (currentRoiDisplayEl) currentRoiDisplayEl.innerHTML = `0.00%`;
          if (planDisplayEl) planDisplayEl.textContent = `N/A`;
          if (settlementTimeDisplayEl) {
            settlementTimeDisplayEl.textContent = `N/A`;
            if (settlementCountdownIntervalWallet) {
                clearInterval(settlementCountdownIntervalWallet);
                settlementCountdownIntervalWallet = null;
            }
          }
        }
      }, (error) => {
        currentUserData = null;
        console.error("Error fetching user wallet data:", error);
        const setTextOnError = (el, text, unitHtml = '') => { if (el) el.innerHTML = text + unitHtml; };
        setTextOnError(totalPortfolioValueDisplayEl, 'Error', ` <span id="portfolio-currency-code" class="text-2xl text-gray-400">${selectedDisplayCurrency}</span>`);
        setTextOnError(zsgBalanceDisplayEl, 'Error', ` ${getZsgIcon('large')}`);
        setTextOnError(usdtBalanceDisplayEl, 'Error', ` ${getUsdtIcon('large')}`);
        setTextOnError(currentRoiDisplayEl, 'Error');
        setTextOnError(planDisplayEl, 'Error');
        if (settlementTimeDisplayEl) {
            setTextOnError(settlementTimeDisplayEl, 'Error');
            if (settlementCountdownIntervalWallet) {
                clearInterval(settlementCountdownIntervalWallet);
                settlementCountdownIntervalWallet = null;
            }
        }
      });
    }

    if (currencySelectorEl) {
        currencySelectorEl.addEventListener('change', function() {
            selectedDisplayCurrency = this.value;
            const portfolioCurrencyCodeSpan = document.getElementById('portfolio-currency-code');
            if (portfolioCurrencyCodeSpan) portfolioCurrencyCodeSpan.textContent = selectedDisplayCurrency;
            if (currentUserId) {
                updateWalletData(currentUserId);
            } else {
                if (totalPortfolioValueDisplayEl) totalPortfolioValueDisplayEl.innerHTML = `0.00 <span id="portfolio-currency-code" class="text-2xl text-gray-400">${selectedDisplayCurrency}</span>`;
            }
        });
    }

    function formatFirebaseTimestamp(timestamp) {
        if (!timestamp) return 'N/A';
        if (typeof timestamp === 'object' && timestamp.hasOwnProperty('.sv')) return 'Processing...';
        try {
            return new Date(timestamp).toLocaleString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: 'numeric', minute: '2-digit', hour12: true
            });
        } catch (e) {
            console.error("Error formatting timestamp:", e);
            return 'Invalid Date';
        }
    }

    function showTransactionDetails(txData, type) {
        if (!transactionDetailModalEl || !transactionDetailTitleEl || !transactionDetailContentEl) return;
        transactionDetailTitleEl.textContent = `${type} Details`;
        let detailsHtml = '<dl class="detail-grid">';
        if (type === 'Withdrawal') {
            detailsHtml += `<dt>ID:</dt><dd>${txData.id}</dd>`;
            detailsHtml += `<dt>Date:</dt><dd>${formatFirebaseTimestamp(txData.requestedAt)}</dd>`;
            detailsHtml += `<dt>Amount:</dt><dd>${getCurrencyDisplayHtml(txData.currency, parseFloat(txData.amount), txData.currency === 'USDT' ? 2 : 2, 'small')}</dd>`;
            detailsHtml += `<dt>Method:</dt><dd>${txData.method}</dd>`;
            detailsHtml += `<dt>Status:</dt><dd class="capitalize ${'tx-status-' + (txData.status?.toLowerCase() || 'unknown')}">${txData.status}</dd>`;
            if (txData.method === 'IMPS/NEFT') {
                detailsHtml += `<dt>Account Name:</dt><dd>${txData.fullName || 'N/A'}</dd>`;
                detailsHtml += `<dt>IFSC:</dt><dd>${txData.ifscCode || 'N/A'}</dd>`;
                detailsHtml += `<dt>Account No.:</dt><dd>${txData.accountNumber || 'N/A'}</dd>`;
                detailsHtml += `<dt>USDT Deducted:</dt><dd>${(txData.usdtEquivalentDeducted?.toFixed(2) || 'N/A')} ${getCurrencyLabelHtml('USDT', 'small')}</dd>`;
                if (txData.conversionRateSnapshot) detailsHtml += `<dt>Rate (USDT/INR):</dt><dd>${txData.conversionRateSnapshot}</dd>`;
            } else if (txData.method === 'USDT') {
                detailsHtml += `<dt>To Address:</dt><dd>${txData.usdtAddress || 'N/A'}</dd>`;
            }
        } else if (type === 'Swap') {
            detailsHtml += `<dt>ID:</dt><dd>${txData.id}</dd>`;
            detailsHtml += `<dt>Date:</dt><dd>${formatFirebaseTimestamp(txData.swappedAt)}</dd>`;
            detailsHtml += `<dt>Swapped:</dt><dd>${getCurrencyDisplayHtml(txData.fromCurrency, parseFloat(txData.amountSwapped), txData.fromCurrency === 'USDT' ? 2 : 4, 'small')}</dd>`;
            detailsHtml += `<dt>Received:</dt><dd>${getCurrencyDisplayHtml(txData.toCurrency, parseFloat(txData.amountReceived), txData.toCurrency === 'USDT' ? 2 : 4, 'small')}</dd>`;
            detailsHtml += `<dt>Rate (ZSG/USDT):</dt><dd>1 ${getCurrencyLabelHtml('ZSG', 'small')} = ${txData.rateSnapshot?.toFixed(4) || 'N/A'} ${getCurrencyLabelHtml('USDT', 'small')}</dd>`;
            detailsHtml += `<dt>Status:</dt><dd class="capitalize ${'tx-status-' + (txData.status?.toLowerCase() || 'unknown')}">${txData.status}</dd>`;
        }
        detailsHtml += '</dl>';
        transactionDetailContentEl.innerHTML = detailsHtml;
        transactionDetailModalEl.style.display = "block";
    }

    function displayTransactionHistory(userId) {
        const userTransactionsRef = query(ref(database, `withdrawalRequests/${userId}`));
        onValue(userTransactionsRef, (snapshot) => {
            if (!transactionHistoryListEl || !noTransactionsMessageEl) return;
            transactionHistoryListEl.innerHTML = '';
            if (snapshot.exists()) {
                noTransactionsMessageEl.style.display = 'none';
                let transactions = [];
                snapshot.forEach(childSnapshot => transactions.push({ id: childSnapshot.key, ...childSnapshot.val() }));
                transactions.sort((a, b) => (b.requestedAt || 0) - (a.requestedAt || 0));
                transactions.forEach(tx => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'transaction-item';
                    const statusClass = `tx-status-${tx.status?.toLowerCase() || 'unknown'}`;
                    itemEl.innerHTML = `
                        <div class="transaction-details">
                            <p class="font-medium text-gray-100 tx-type-withdrawal">${tx.method} Withdrawal (${tx.method === 'USDT' ? getCurrencyLabelHtml(tx.currency, 'small') : tx.currency})</p>
                            <p class="text-xs text-gray-500">${formatFirebaseTimestamp(tx.requestedAt)}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold text-base tx-type-withdrawal">-${getCurrencyDisplayHtml(tx.currency, parseFloat(tx.amount), tx.currency === 'USDT' ? 2 : 2, 'small')}</p>
                            <p class="text-xs ${statusClass} capitalize">${tx.status}</p>
                        </div>`;
                    itemEl.addEventListener('click', () => showTransactionDetails(tx, 'Withdrawal'));
                    transactionHistoryListEl.appendChild(itemEl);
                });
            } else {
                noTransactionsMessageEl.textContent = 'No withdrawal history found.';
                noTransactionsMessageEl.style.display = 'block';
            }
        }, (error) => {
            console.error("Error fetching transaction history:", error);
            if (noTransactionsMessageEl) {
                noTransactionsMessageEl.textContent = 'Could not load transaction history.';
                noTransactionsMessageEl.style.display = 'block';
            }
        });
    }

    function displaySwapHistory(userId) {
        const userSwapsRef = query(ref(database, `swapRequests/${userId}`));
        onValue(userSwapsRef, (snapshot) => {
            if (!swapHistoryListEl || !noSwapsMessageEl) return;
            swapHistoryListEl.innerHTML = '';
            if (snapshot.exists()) {
                noSwapsMessageEl.style.display = 'none';
                let swaps = [];
                snapshot.forEach(childSnapshot => swaps.push({ id: childSnapshot.key, ...childSnapshot.val() }));
                swaps.sort((a, b) => (b.swappedAt || 0) - (a.swappedAt || 0));
                swaps.forEach(swap => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'transaction-item';
                    itemEl.innerHTML = `
                        <div class="transaction-details">
                            <p class="font-medium text-gray-100 tx-type-swap">Swap ${getCurrencyLabelHtml(swap.fromCurrency, 'small')} to ${getCurrencyLabelHtml(swap.toCurrency, 'small')}</p>
                            <p class="text-xs text-gray-500">${formatFirebaseTimestamp(swap.swappedAt)}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold text-sm text-gray-300"><span class="text-red-500">-${getCurrencyDisplayHtml(swap.fromCurrency, parseFloat(swap.amountSwapped), swap.fromCurrency === 'USDT' ? 2 : 4, 'small')}</span></p>
                            <p class="font-semibold text-sm text-gray-300 mt-1"><span class="text-green-500">+${getCurrencyDisplayHtml(swap.toCurrency, parseFloat(swap.amountReceived), swap.toCurrency === 'USDT' ? 2 : 4, 'small')}</span></p>
                        </div>`;
                    itemEl.addEventListener('click', () => showTransactionDetails(swap, 'Swap'));
                    swapHistoryListEl.appendChild(itemEl);
                });
            } else {
                noSwapsMessageEl.textContent = 'No swap history found.';
                noSwapsMessageEl.style.display = 'block';
            }
        }, (error) => {
            console.error("Error fetching swap history:", error);
            if (noSwapsMessageEl) {
                noSwapsMessageEl.textContent = 'Could not load swap history.';
                noSwapsMessageEl.style.display = 'block';
            }
        });
    }

    if (userMenuToggleBtnEl && userDropdownMenuEl && userMenuContainerEl) {
        userMenuToggleBtnEl.addEventListener('click', (event) => {
            event.stopPropagation();
            userDropdownMenuEl.classList.toggle('hidden');
        });
        document.addEventListener('click', (event) => {
            if (!userMenuContainerEl.contains(event.target) && !userDropdownMenuEl.classList.contains('hidden')) {
                userDropdownMenuEl.classList.add('hidden');
            }
        });
    }
    if (logoutMenuBtnEl) {
        logoutMenuBtnEl.addEventListener('click', async () => {
            if (!auth) return showGenericMessage("Auth service unavailable.", true);
            try {
                await signOut(auth);
                showGenericMessage("Successfully logged out.", false);
                if (userDropdownMenuEl) userDropdownMenuEl.classList.add('hidden');
                 // Redirect to login page after logout
                window.location.href = './index.html'; // FIXED: Changed to absolute path
            } catch (error) {
                console.error("Logout Error:", error);
                showGenericMessage("Logout failed: " + error.message, true);
            }
        });
    }
    if (changePasswordMenuBtnEl) {
        changePasswordMenuBtnEl.addEventListener('click', async () => {
            if (!auth || !auth.currentUser) return showGenericMessage("Must be logged in.", true);
            const userEmail = auth.currentUser.email;
            if (!userEmail) return showGenericMessage("Email not available.", true);
            try {
                await sendPasswordResetEmail(auth, userEmail);
                showGenericMessage(`Password reset link sent to ${userEmail}.`, false);
                if (userDropdownMenuEl) userDropdownMenuEl.classList.add('hidden');
            } catch (error) {
                console.error("Send Password Reset Email Error:", error);
                showGenericMessage("Failed to send reset email: " + error.message, true);
            }
        });
    }

    if (helpMenuBtnEl) {
        helpMenuBtnEl.addEventListener('click', () => {
            window.location.href = './help.html'; // FIXED: Changed to absolute path
            if (userDropdownMenuEl) userDropdownMenuEl.classList.add('hidden');
        });
    }


    if (auth && database) {
        onAuthStateChanged(auth, (user) => {
          const authStatusEl = document.getElementById("auth-status");
          const userIdDisplayEl = document.getElementById("user-id-display");
          if (user) {
            currentUserId = user.uid;
            if (authStatusEl) authStatusEl.textContent = `Logged in: ${user.email || 'Authenticated User'}`;
            if (userIdDisplayEl) userIdDisplayEl.textContent = `User ID: ${user.uid}`;
            updateWalletData(currentUserId);
            displayTransactionHistory(currentUserId);
            displaySwapHistory(currentUserId);
            if (userMenuToggleBtnEl) userMenuToggleBtnEl.classList.remove('hidden');
            if (userMenuEmailEl) userMenuEmailEl.textContent = user.email || 'N/A';
          } else {
            currentUserId = null;
            currentUserData = null;
            if (authStatusEl) authStatusEl.textContent = 'Not Authenticated. Redirecting to login...';
            if (userIdDisplayEl) userIdDisplayEl.textContent = 'User ID: -';
            // Redirect to login page if not authenticated
            setTimeout(() => {
                window.location.href = './index.html'; // FIXED: Changed to absolute path
            }, 1500); // Delay for user to see the message

            setInitialLoadingState(); // Reset UI elements
            if (currentRoiDisplayEl) currentRoiDisplayEl.innerHTML = `0.00%`;
            if (planDisplayEl) planDisplayEl.textContent = `N/A`;
            if (settlementTimeDisplayEl) {
                settlementTimeDisplayEl.textContent = `N/A`;
                if (settlementCountdownIntervalWallet) {
                    clearInterval(settlementCountdownIntervalWallet);
                    settlementCountdownIntervalWallet = null;
                }
            }

            if (noTransactionsMessageEl) { noTransactionsMessageEl.textContent = 'Please log in to view history.'; noTransactionsMessageEl.style.display = 'block';}
            if (transactionHistoryListEl) transactionHistoryListEl.innerHTML = '';
            if (noSwapsMessageEl) { noSwapsMessageEl.textContent = 'Please log in to view history.'; noSwapsMessageEl.style.display = 'block';}
            if (swapHistoryListEl) swapHistoryListEl.innerHTML = '';
            if (userNoticeBannerEl) userNoticeBannerEl.style.display = 'none';
            // Do not hide appContainerEl immediately, let redirect handle it.
            if (userMenuToggleBtnEl) userMenuToggleBtnEl.classList.add('hidden');
            if (userDropdownMenuEl) userDropdownMenuEl.classList.add('hidden');
            if (userMenuEmailEl) userMenuEmailEl.textContent = 'Loading...';
            if(topupFundsBtnEl) topupFundsBtnEl.disabled = true; // Disable actions if not logged in
            if(openSwapModalBtnEl) { openSwapModalBtnEl.disabled = true; openSwapModalBtnEl.classList.add('opacity-50', 'cursor-not-allowed'); }
            if(openWithdrawModalButtonEl) { openWithdrawModalButtonEl.disabled = true; openWithdrawModalButtonEl.classList.add('opacity-50', 'cursor-not-allowed'); }
          }
        });
    } else {
        console.error("Firebase auth or database unavailable. Wallet functionality limited.");
        if (appContainerEl) appContainerEl.innerHTML = '<div class="text-center p-10"><h1 class="text-2xl font-semibold text-red-500">Critical Error</h1><p class="text-gray-400 mt-2">Core services unavailable.</p></div>';
    }

    if (openWithdrawModalButtonEl && withdrawalModalEl) {
        openWithdrawModalButtonEl.onclick = function() {
            if (!currentUserId) return showGenericMessage("Please log in to withdraw.", true);
            if (currentUserData && currentUserData.isWithdrawalBlocked) return showGenericMessage("Withdrawals are disabled.", true);
            withdrawalModalEl.style.display = "block";
            if(impsNeftFormEl) impsNeftFormEl.style.display = "block";
            if(usdtTrc20FormEl) usdtTrc20FormEl.style.display = "none";
            if(selectImpsNeftBtnEl) selectImpsNeftBtnEl.classList.add('active');
            if(selectUsdtTrc20BtnEl) selectUsdtTrc20BtnEl.classList.remove('active');
            if(withdrawalImpsAmountInputEl) withdrawalImpsAmountInputEl.value = '';
            if(withdrawalUsdtAmountInputEl) withdrawalUsdtAmountInputEl.value = '';
            if(withdrawalUsdtAddressInputEl) withdrawalUsdtAddressInputEl.value = '';
             if (withdrawalUsdtAmountLabelEl) withdrawalUsdtAmountLabelEl.innerHTML = `Amount (${getCurrencyLabelHtml('USDT', 'medium')}):`;

            const userBankDetailsRef = ref(database, `users/${currentUserId}/bankDetails`);
            get(userBankDetailsRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const d = snapshot.val();
                    if(withdrawalFullNameInputEl) withdrawalFullNameInputEl.value = d.fullName || '';
                    if(withdrawalIfscCodeInputEl) withdrawalIfscCodeInputEl.value = d.ifscCode || '';
                    if(withdrawalAccountNumberInputEl) withdrawalAccountNumberInputEl.value = d.accountNumber || '';
                } else {
                    if(withdrawalFullNameInputEl) withdrawalFullNameInputEl.value = '';
                    if(withdrawalIfscCodeInputEl) withdrawalIfscCodeInputEl.value = '';
                    if(withdrawalAccountNumberInputEl) withdrawalAccountNumberInputEl.value = '';
                }
            }).catch(e => console.error("Error fetching bank details:", e));
        }
    }
    if (closeWithdrawModalBtnEl && withdrawalModalEl) closeWithdrawModalBtnEl.onclick = () => withdrawalModalEl.style.display = "none";
    window.addEventListener('click', (event) => {
        if (event.target == withdrawalModalEl && withdrawalModalEl) withdrawalModalEl.style.display = "none";
        if (event.target == swapModalEl && swapModalEl) swapModalEl.style.display = "none";
        if (event.target == transactionDetailModalEl && transactionDetailModalEl) transactionDetailModalEl.style.display = "none";
    });
    if (selectImpsNeftBtnEl && selectUsdtTrc20BtnEl && impsNeftFormEl && usdtTrc20FormEl) {
        selectImpsNeftBtnEl.onclick = () => {
            impsNeftFormEl.style.display = "block"; usdtTrc20FormEl.style.display = "none";
            selectImpsNeftBtnEl.classList.add('active'); selectUsdtTrc20BtnEl.classList.remove('active');
        }
        selectUsdtTrc20BtnEl.onclick = () => {
            impsNeftFormEl.style.display = "none"; usdtTrc20FormEl.style.display = "block";
            selectUsdtTrc20BtnEl.classList.add('active'); selectImpsNeftBtnEl.classList.remove('active');
            if (withdrawalUsdtAmountLabelEl) withdrawalUsdtAmountLabelEl.innerHTML = `Amount (${getCurrencyLabelHtml('USDT', 'medium')}):`;
        }
    }
    async function handleWithdrawal(amount, method, details) {
        if (!currentUserId) return showGenericMessage("User not authenticated.", true);
        if (currentUserData && currentUserData.isWithdrawalBlocked) return showGenericMessage("Withdrawals disabled.", true);
        const parsedAmount = parseFloat(amount);
        if (isNaN(parsedAmount) || parsedAmount <= 0) return showGenericMessage("Amount must be positive.", true);

        const btn = method === 'IMPS/NEFT' ? submitImpsWithdrawalBtnEl : submitUsdtWithdrawalBtnEl;
        const originalBtnText = btn.textContent;
        btn.disabled = true; btn.innerHTML = `<span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>Processing...`;

        try {
            const userRef = ref(database, `users/${currentUserId}`);
            const userSnapshot = await get(userRef);
            if (!userSnapshot.exists()) throw new Error("User data not found.");
            const userData = userSnapshot.val();
            let availableUsdt = parseFloat(userData.withdrawalAvailable) || parseFloat(userData.usdtBalance) || 0;
            let usdtDeducted;

            if (method === 'IMPS/NEFT') {
                usdtDeducted = parsedAmount / INR_CONVERSION_RATE;
                if (usdtDeducted > availableUsdt) throw new Error(`Insufficient balance. Need ${usdtDeducted.toFixed(2)} ${getCurrencyLabelHtml('USDT','small')}.`);
                const bank = { fullName: details.fullName, ifscCode: details.ifscCode, accountNumber: details.accountNumber };
                if (!userData.bankDetails || JSON.stringify(userData.bankDetails) !== JSON.stringify(bank)) {
                    await update(ref(database, `users/${currentUserId}/bankDetails`), bank);
                }
            } else if (method === 'USDT') {
                usdtDeducted = parsedAmount;
                if (usdtDeducted > availableUsdt) throw new Error(`Insufficient ${getCurrencyLabelHtml('USDT','small')} balance.`);
            } else throw new Error("Invalid method.");

            const newBalance = availableUsdt - usdtDeducted;
            const reqRef = push(ref(database, `withdrawalRequests/${currentUserId}`));
            const reqData = {
                userId: currentUserId, amount: parsedAmount, currency: method === 'IMPS/NEFT' ? 'INR' : 'USDT',
                usdtEquivalentDeducted: parseFloat(usdtDeducted.toFixed(2)), method: method, status: 'Pending',
                requestedAt: serverTimestamp(), conversionRateSnapshot: method === 'IMPS/NEFT' ? INR_CONVERSION_RATE : null,
                ...(method === 'IMPS/NEFT' && { fullName: details.fullName, ifscCode: details.ifscCode, accountNumber: details.accountNumber }),
                ...(method === 'USDT' && { usdtAddress: details.usdtAddress })
            };
            await set(reqRef, reqData);
            const updates = { usdtBalance: parseFloat(newBalance.toFixed(2)) };
            if (userData.hasOwnProperty('withdrawalAvailable')) {
                updates.withdrawalAvailable = parseFloat(newBalance.toFixed(2));
            }
            await update(userRef, updates);

            showGenericMessage(`Withdrawal for ${parsedAmount} ${reqData.currency === 'USDT' ? getCurrencyLabelHtml('USDT', 'small') : reqData.currency} submitted!`, false);
            if(withdrawalModalEl) withdrawalModalEl.style.display = "none";
        } catch (error) {
            console.error("Withdrawal error:", error);
            showGenericMessage("Withdrawal failed: " + error.message, true);
        } finally {
            if (btn) { btn.disabled = false; btn.innerHTML = originalBtnText; }
        }
    }
    if (submitImpsWithdrawalBtnEl) {
        submitImpsWithdrawalBtnEl.onclick = () => {
            const fN = withdrawalFullNameInputEl.value.trim(), iC = withdrawalIfscCodeInputEl.value.trim().toUpperCase();
            const aN = withdrawalAccountNumberInputEl.value.trim(), amt = withdrawalImpsAmountInputEl.value;
            if (!fN || !iC || !aN || !amt) return showGenericMessage("Fill all IMPS/NEFT fields.", true);
            if (parseFloat(amt) <= 0) return showGenericMessage("INR Amount must be positive.", true);
            if (!/^[A-Z]{4}0[A-Z0-9]{6}$/.test(iC)) return showGenericMessage("Invalid IFSC. Ex: SBIN0001234.", true);
            if (!/^\d{9,18}$/.test(aN)) return showGenericMessage("Invalid account no. (9-18 digits).", true);
            handleWithdrawal(amt, 'IMPS/NEFT', { fullName: fN, ifscCode: iC, accountNumber: aN });
        };
    }
    if (submitUsdtWithdrawalBtnEl) {
        submitUsdtWithdrawalBtnEl.onclick = () => {
            const amt = withdrawalUsdtAmountInputEl.value, addr = withdrawalUsdtAddressInputEl.value.trim();
            if (!amt || !addr) return showGenericMessage(`Fill all ${getCurrencyLabelHtml('USDT', 'small')} fields.`, true);
            if (parseFloat(amt) <= 0) return showGenericMessage(`${getCurrencyLabelHtml('USDT', 'small')} Amount must be positive.`, true);
            if (!/^T[1-9A-HJ-NP-Za-km-z]{33}$/.test(addr)) return showGenericMessage("Invalid TRC20 address.", true);
            handleWithdrawal(amt, 'USDT', { usdtAddress: addr });
        };
    }

    // Swap Modal Logic (One-way USDT to ZSG)
    function updateSwapModalRateDisplay() {
        if (swapRateDisplayEl) swapRateDisplayEl.innerHTML = `Rate: 1 ${getCurrencyLabelHtml('ZSG', 'small')} = ${currentZSGValue.toFixed(4)} ${getCurrencyLabelHtml('USDT', 'small')}`;
        calculateSwapReceiveAmount();
    }
    function updateSwapModalBalances() {
        if (!currentUserData || !swapBalanceInfoEl) return;
        const uBal = parseFloat(currentUserData.usdtBalance) || 0;
        swapBalanceInfoEl.innerHTML = `${getCurrencyLabelHtml('USDT', 'small')} Balance: <span class="font-medium">${uBal.toFixed(2)}</span>`;
    }
    function calculateSwapReceiveAmount() {
        if (!swapAmountInputEl || !receiveAmountDisplayEl || currentZSGValue <= 0) {
            if(receiveAmountDisplayEl) receiveAmountDisplayEl.value = '0.0000'; return;
        }
        const amtSwap = parseFloat(swapAmountInputEl.value);
        if (isNaN(amtSwap) || amtSwap <= 0) { receiveAmountDisplayEl.value = '0.0000'; return; }
        const amtRec = amtSwap / currentZSGValue;
        receiveAmountDisplayEl.value = amtRec.toFixed(4);
    }
    function setupSwapModal() {
        if (!swapFromLabelEl || !swapToLabelEl || !swapAmountLabelEl || !receiveAmountLabelEl) return;
        swapFromLabelEl.innerHTML = getCurrencyLabelHtml("USDT", "medium");
        swapToLabelEl.innerHTML = getCurrencyLabelHtml("ZSG", "medium"); // Use icon for ZSG
        swapAmountLabelEl.innerHTML = `Amount to Swap (${getCurrencyLabelHtml("USDT", "small")}):`;
        receiveAmountLabelEl.innerHTML = `You will receive (approx. ${getCurrencyLabelHtml("ZSG", "small")}):`;
        updateSwapModalBalances(); calculateSwapReceiveAmount(); updateSwapModalRateDisplay();
    }

    if (openSwapModalBtnEl && swapModalEl) {
        openSwapModalBtnEl.onclick = () => {
            if (!currentUserId) return showGenericMessage("Please log in to swap.", true);
            if (currentUserData && currentUserData.isWithdrawalBlocked) return showGenericMessage("Swaps disabled (withdrawals blocked).", true);
            if (currentZSGValue <= 0) return showGenericMessage("Swap rate unavailable.", true);

            if(swapAmountInputEl) swapAmountInputEl.value = '';
            if(receiveAmountDisplayEl) receiveAmountDisplayEl.value = '';
            setupSwapModal();
            swapModalEl.style.display = "block";
        }
    }
    if (closeSwapModalBtnEl && swapModalEl) closeSwapModalBtnEl.onclick = () => swapModalEl.style.display = "none";
    if (swapAmountInputEl) swapAmountInputEl.addEventListener('input', calculateSwapReceiveAmount);

    async function handleSwap() {
        if (!currentUserId || !currentUserData) return showGenericMessage("User not authenticated/data not loaded.", true);
        if (currentUserData.isWithdrawalBlocked) return showGenericMessage("Swaps disabled (withdrawals blocked).", true);
        if (currentZSGValue <= 0) return showGenericMessage("Swap rate unavailable.", true);

        const amtSwap = parseFloat(swapAmountInputEl.value);
        if (isNaN(amtSwap) || amtSwap <= 0) return showGenericMessage("Enter a valid positive amount.", true);

        const btn = confirmSwapBtnEl; const originalBtnText = btn.textContent;
        btn.disabled = true; btn.innerHTML = `<span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>Processing...`;

        try {
            const userRef = ref(database, `users/${currentUserId}`);
            const latestUserSnap = await get(userRef);
            if (!latestUserSnap.exists()) throw new Error("User data not found.");
            const latestData = latestUserSnap.val();
            let uBal = parseFloat(latestData.usdtBalance) || 0, zBal = parseFloat(latestData.zsgTokenBalance) || 0;
            let newUBal, newZBal, amtRec;

            if (amtSwap > uBal) throw new Error(`Insufficient ${getCurrencyLabelHtml('USDT', 'small')} balance.`);
            amtRec = amtSwap / currentZSGValue;
            newUBal = uBal - amtSwap;
            newZBal = zBal + amtRec;

            await update(userRef, {
                usdtBalance: parseFloat(newUBal.toFixed(2)),
                zsgTokenBalance: parseFloat(newZBal.toFixed(4))
            });
            const swapReqRef = push(ref(database, `swapRequests/${currentUserId}`));
            await set(swapReqRef, {
                userId: currentUserId,
                fromCurrency: 'USDT',
                toCurrency: 'ZSG',
                amountSwapped: amtSwap,
                amountReceived: parseFloat(amtRec.toFixed(4)),
                rateSnapshot: currentZSGValue,
                swappedAt: serverTimestamp(),
                status: 'Completed'
            });
            showGenericMessage("Swap successful!", false);
            if(swapModalEl) swapModalEl.style.display = "none";
        } catch (error) {
            console.error("Swap error:", error);
            showGenericMessage("Swap failed: " + error.message, true);
        } finally {
            if (btn) { btn.disabled = false; btn.innerHTML = originalBtnText; }
        }
    }
    if (confirmSwapBtnEl) confirmSwapBtnEl.onclick = handleSwap;

  </script>
</body>
</html>
