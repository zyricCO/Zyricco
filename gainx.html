<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GainX Wallet - Professional Black Theme with Swap</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #000; /* Base background is black */
      color: #e5e7eb; /* Default light text color */
    }

    /* Modal Styles adapted for black theme */
    .modal {
      display: none;
      position: fixed;
      z-index: 50;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.75);
      font-family: 'Inter', sans-serif;
    }

    .modal-content {
      background-color: #111827;
      color: #e5e7eb;
      margin: 8% auto;
      padding: 25px;
      border: 1px solid #374151;
      width: 90%;
      max-width: 500px;
      border-radius: 10px;
      position: relative;
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    }

    .modal-content h2 {
        margin-top: 0;
        font-size: 1.5rem;
        font-weight: 600;
        color: #f3f4f6;
        text-align: center;
        margin-bottom: 24px;
    }
    .modal-content h4 { /* Used for sub-sections in modals */
        font-size: 1.125rem;
        font-weight: 600;
        margin-top: 20px;
        margin-bottom: 12px;
        color: #d1d5db;
        border-bottom: 1px solid #374151;
        padding-bottom: 8px;
    }

    .close-button {
      color: #9ca3af;
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 28px;
      font-weight: bold;
      line-height: 1;
    }

    .close-button:hover,
    .close-button:focus {
      color: #f3f4f6;
      text-decoration: none;
      cursor: pointer;
    }

    /* Styles for Withdrawal and Swap Modals */
    .options-group { /* For withdrawal options / swap direction */
      margin-bottom: 25px;
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .option-btn { /* Generic button for options */
      padding: 10px 18px;
      border: 1px solid #374151;
      background-color: #1f2937;
      color: #e5e7eb;
      cursor: pointer;
      border-radius: 6px;
      font-size: 0.95em;
      font-weight: 500;
      transition: background-color 0.2s, border-color 0.2s, color 0.2s;
    }
    .option-btn:hover {
        background-color: #374151;
        border-color: #4b5563;
    }

    .option-btn.active {
      background-color: #0ea5e9;
      color: white;
      border-color: #0ea5e9;
    }
    .option-btn.active:hover {
      background-color: #0284c7;
    }

    .form-section label {
      display: block;
      margin-top: 16px;
      margin-bottom: 8px;
      font-weight: 500;
      color: #d1d5db;
      font-size: 0.9rem;
    }

    .form-section input[type="text"],
    .form-section input[type="number"],
    .form-section select { /* Added select here */
      width: 100%;
      padding: 12px;
      margin-bottom: 16px;
      border: 1px solid #374151;
      background-color: #1f2937;
      color: #e5e7eb;
      border-radius: 6px;
      box-sizing: border-box;
      font-size: 0.95em;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
     .form-section input[type="text"]:focus,
    .form-section input[type="number"]:focus,
    .form-section select:focus { /* Added select here */
        border-color: #0ea5e9;
        outline: none;
        box-shadow: 0 0 0 2px rgba(14,165,233,0.3);
    }
    /* Specific style for currency selector to make it less wide if needed */
    #currencySelector {
        padding: 8px 12px; /* Adjusted padding */
        font-size: 0.9em;
        margin-bottom: 0; /* No bottom margin if it's inline */
        width: auto; /* Allow it to size based on content */
        min-width: 100px; /* Minimum width */
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
    }


    .form-section button[type="button"], .form-section button[type="submit"] { /* Target specific buttons */
      background-color: #10b981;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      margin-top: 20px;
      width: 100%;
      transition: background-color 0.2s;
    }

    .form-section button[type="button"]:hover, .form-section button[type="submit"]:hover {
      background-color: #059669;
    }
    .form-section button[type="button"]:disabled, .form-section button[type="submit"]:disabled {
        background-color: #4b5563;
        color: #9ca3af;
        cursor: not-allowed;
    }

    .info-text {
        font-size: 0.875rem;
        color: #9ca3af; /* gray-400 */
        margin-top: -10px;
        margin-bottom: 16px;
    }
     .rate-display {
        font-size: 0.9rem;
        color: #60a5fa; /* blue-400 */
        text-align: center;
        margin-top: 10px;
        margin-bottom: 20px;
        padding: 8px;
        background-color: #1f2937; /* bg-gray-800 */
        border-radius: 4px;
    }


    .transaction-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #1f2937;
        cursor: pointer; /* Make items clickable */
        transition: background-color 0.1s;
    }
    .transaction-item:hover {
        background-color: #1f2937; /* Slight hover effect */
    }
    .transaction-item:last-child {
        border-bottom: none;
    }
    .transaction-details p:first-child {
        font-weight: 500;
    }
    .tx-type-deposit { color: #22c55e; }
    .tx-type-withdrawal { color: #ef4444; }
    .tx-type-swap { color: #a855f7; } /* purple-500 for swaps */
    .tx-status-pending { color: #eab308; }
    .tx-status-completed { color: #22c55e; }
    .tx-status-failed { color: #ef4444; }

    /* Transaction Detail Modal Styles */
    #transactionDetailModal .modal-content {
        max-width: 550px; /* Slightly wider for details */
    }
    .detail-grid {
        display: grid;
        grid-template-columns: auto 1fr; /* Label and value */
        gap: 8px 16px; /* Row and column gap */
        margin-bottom: 16px;
    }
    .detail-grid dt { /* Definition Term (Label) */
        font-weight: 500;
        color: #9ca3af; /* gray-400 */
        text-align: right;
    }
    .detail-grid dd { /* Definition Description (Value) */
        color: #e5e7eb; /* gray-200 */
        word-break: break-all; /* For long strings like addresses */
    }

    /* User Notice Banner Styles */
    #userNoticeBanner {
        display: none; /* Hidden by default */
        padding: 1rem;
        margin-bottom: 1.5rem;
        border-radius: 0.375rem; /* Tailwind rounded-md */
        font-weight: 500;
    }
    #userNoticeBanner.notice-info {
        background-color: #1e40af; /* blue-800 */
        color: #bfdbfe; /* blue-200 */
    }
    #userNoticeBanner.notice-critical {
        background-color: #b91c1c; /* red-700 */
        color: #fecaca; /* red-200 */
    }

    .currency-logo {
        width: 20px; /* Adjust size as needed */
        height: 20px; /* Adjust size as needed */
        display: inline-block;
        vertical-align: middle;
        margin-left: 4px;
    }
    .swap-currency-logo {
        width: 24px;
        height: 24px;
        display: inline-block;
        vertical-align: middle;
    }
    .history-currency-logo {
        width: 16px;
        height: 16px;
        display: inline-block;
        vertical-align: middle;
        margin-left: 3px;
    }


    @media (max-width: 600px) {
      .modal-content {
        margin: 10% auto;
        width: 95%;
        padding: 20px;
      }
      .options-group {
        flex-direction: column;
      }
      .option-btn {
        width: 100%;
        margin-bottom: 10px;
      }
       .option-btn:last-child {
        margin-bottom: 0;
      }
      #currencySelector{
        width: 100%; /* Full width on mobile */
        margin-top: 8px;
      }
      .portfolio-header {
        flex-direction: column;
        align-items: center;
      }
      .detail-grid {
        grid-template-columns: 1fr; /* Stack label and value on mobile */
      }
      .detail-grid dt {
        text-align: left;
        margin-bottom: 2px;
        color: #6b7280; /* gray-500 */
      }
    }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start p-4 sm:p-6 bg-black">
  <div id="userNoticeBanner"></div>
  <div id="app-container" class="w-full max-w-2xl space-y-8 mt-8 sm:mt-12">
    <header class="relative text-center mb-12"> <div class="inline-block mb-4 text-4xl font-bold text-sky-400">
        Gain<span class="text-gray-50">X</span>
      </div>
      <h1 id="main-header-title" class="text-3xl md:text-4xl font-semibold text-gray-100 mb-3">Loading IP Address...</h1>
      <p id="auth-status" class="text-sm text-gray-400">Connecting...</p>
      <p id="user-id-display" class="text-xs text-gray-500 mt-1">User ID: -</p>

      <div id="userMenuContainer" class="absolute top-0 right-0 mt-0 mr-0 sm:mt-2 sm:mr-2">
        <button id="userMenuToggleBtn" class="p-2 rounded-full hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-sky-500 hidden">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 text-gray-300 hover:text-sky-400">
            <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </button>
        <div id="userDropdownMenu" class="absolute right-0 mt-2 w-56 bg-gray-800 border border-gray-700 rounded-md shadow-xl py-1 z-[60] hidden"> <div class="px-4 py-3 border-b border-gray-700">
            <p class="text-xs text-gray-400 text-left">Signed in as</p>
            <p id="userMenuEmail" class="text-sm font-medium text-gray-100 truncate text-left">Loading...</p>
          </div>
          <nav class="py-1">
            <button id="changePasswordMenuBtn" class="w-full text-left block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 hover:text-sky-300 transition-colors">
              Change Password
            </button>
            <button id="logoutMenuBtn" class="w-full text-left block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 hover:text-sky-300 transition-colors">
              Logout
            </button>
          </nav>
        </div>
      </div>
    </header>

    <div id="wallet-section" class="bg-black shadow-xl rounded-lg p-6 border border-gray-800">
      <div class="mb-6 text-center">
        <div class="flex justify-center items-center gap-4 mb-2 portfolio-header">
            <h2 class="text-xl font-medium text-gray-300">Total Portfolio Value</h2>
            <select id="currencySelector" class="form-section bg-gray-800 border-gray-700 text-gray-200 rounded-md shadow-sm">
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
                <option value="JPY">JPY</option>
                <option value="GBP">GBP</option>
                <option value="INR">INR</option>
                <option value="CAD">CAD</option>
            </select>
        </div>
        <p id="total-portfolio-value-display" class="text-4xl font-bold text-cyan-400">
          <span class="animate-pulse">Loading...</span> <span id="portfolio-currency-code" class="text-2xl text-gray-400">USD</span>
        </p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="bg-gray-900 p-5 rounded-lg border border-gray-700 shadow-md">
          <h3 class="text-md font-medium text-gray-300 mb-2 flex items-center">
            USDT Balance
            <img src="/images/usdt.png" alt="USDT" class="currency-logo ml-2" onerror="this.style.display='none'; const fe = this.nextElementSibling; if(fe) fe.classList.remove('hidden');"><span class="hidden">USDT</span>
          </h3>
          <p id="usdt-balance-display" class="text-3xl font-semibold text-gray-100">
            {/* Content dynamically set by createCurrencyHtml */}
          </p>
        </div>
        <div class="bg-gray-900 p-5 rounded-lg border border-gray-700 shadow-md">
          <h3 class="text-md font-medium text-gray-300 mb-2 flex items-center">
            ZSG Balance
            <img src="/images/zsg.png" alt="ZSG" class="currency-logo ml-2" onerror="this.style.display='none'; const fe = this.nextElementSibling; if(fe) fe.classList.remove('hidden');"><span class="hidden">ZSG</span>
          </h3>
          <p id="zsg-balance-display" class="text-3xl font-semibold text-gray-100">
            {/* Content dynamically set by createCurrencyHtml */}
          </p>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
        <button id="depositFundsBtn" onclick="window.location.href='deposit_usdt.html'" class="w-full px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-md font-semibold transition shadow-md hover:shadow-lg">Deposit</button>
        <button type="button" id="openSwapModalBtn" class="w-full px-6 py-3 bg-sky-600 hover:bg-sky-700 text-white rounded-md font-semibold transition shadow-md hover:shadow-lg">Swap Tokens</button>
        <button type="button" id="openWithdrawModalGainxBtn" class="w-full px-6 py-3 bg-rose-600 hover:bg-rose-700 text-white rounded-md font-semibold transition shadow-md hover:shadow-lg">Withdraw</button>
      </div>
    </div>

    <div id="history-section" class="bg-black shadow-xl rounded-lg p-6 border border-gray-800">
      <h2 class="text-xl font-medium text-gray-100 mb-5">Transaction History</h2>
      <div id="transaction-history-list" class="space-y-1 max-h-60 overflow-y-auto pr-2">
        <p id="no-transactions-message" class="text-gray-500 p-4 text-center">Loading history...</p>
      </div>
    </div>

    <div id="swap-history-section" class="bg-black shadow-xl rounded-lg p-6 border border-gray-800">
      <h2 class="text-xl font-medium text-gray-100 mb-5">Swap History</h2>
      <div id="swap-history-list" class="space-y-1 max-h-60 overflow-y-auto pr-2">
        <p id="no-swaps-message" class="text-gray-500 p-4 text-center">Loading swap history...</p>
      </div>
    </div>
  </div>

  <div id="withdrawalModal" class="modal">
    <div class="modal-content">
      <span class="close-button" id="closeWithdrawModalBtn">&times;</span>
      <h2>Withdraw Funds</h2>
      <div class="options-group">
        <button id="selectImpsNeftBtn" class="option-btn active">IMPS/NEFT</button>
        <button id="selectUsdtTrc20Btn" class="option-btn">
            USDT-TRC20 <img src="/images/usdt.png" alt="USDT" class="history-currency-logo" onerror="this.style.display='none';">
        </button>
      </div>

      <div id="impsNeftForm" class="form-section">
        <h4>IMPS/NEFT Details</h4>
        <label for="withdrawalFullName">Full Name (as per bank records):</label>
        <input type="text" id="withdrawalFullName" name="withdrawalFullName" required>
        <label for="withdrawalIfscCode">IFSC Code:</label>
        <input type="text" id="withdrawalIfscCode" name="withdrawalIfscCode" required>
        <label for="withdrawalAccountNumber">Bank Account Number:</label>
        <input type="text" id="withdrawalAccountNumber" name="withdrawalAccountNumber" required>
        <label for="withdrawalImpsAmount">Amount (INR):</label>
        <input type="number" id="withdrawalImpsAmount" name="withdrawalImpsAmount" placeholder="e.g., 5000" required min="1">
        <button type="submit" id="submitImpsWithdrawalBtn">Submit IMPS/NEFT Withdrawal</button>
      </div>

      <div id="usdtTrc20Form" class="form-section" style="display: none;">
        <h4>
            USDT-TRC20 Details <img src="/images/usdt.png" alt="USDT" class="history-currency-logo" onerror="this.style.display='none';">
        </h4>
         <label for="withdrawalUsdtAmount">Amount (USDT):</label>
        <input type="number" id="withdrawalUsdtAmount" name="withdrawalUsdtAmount" placeholder="e.g., 100" required min="1">
        <label for="withdrawalUsdtAddress">USDT Wallet Address (TRC20 Network):</label>
        <input type="text" id="withdrawalUsdtAddress" name="withdrawalUsdtAddress" placeholder="Starts with T..." required>
        <button type="submit" id="submitUsdtWithdrawalBtn">Submit USDT Withdrawal</button>
      </div>
    </div>
  </div>

  <div id="swapModal" class="modal">
    <div class="modal-content">
      <span class="close-button" id="closeSwapModalBtn">&times;</span>
      <h2>Swap Tokens</h2>
      <div class="form-section">
        <div class="flex items-center justify-center mb-6">
            <span id="swapFromLabelContainer" class="mr-2 font-medium text-lg text-sky-400 flex items-center">
                <img id="swapFromLogo" src="/images/usdt.png" alt="USDT" class="swap-currency-logo mr-1" onerror="this.style.display='none'; document.getElementById('swapFromText').classList.remove('hidden');"><span id="swapFromText" class="hidden">USDT</span>
            </span>
            <button type="button" id="swapDirectionToggleBtn" class="p-2 rounded-full hover:bg-gray-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-gray-400">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21 3 16.5m0 0L7.5 12M3 16.5h18m-7.5-14L21 6.5m0 0L16.5 12M21 6.5H3" />
                </svg>
            </button>
            <span id="swapToLabelContainer" class="ml-2 font-medium text-lg text-emerald-400 flex items-center">
                <img id="swapToLogo" src="/images/zsg.png" alt="ZSG" class="swap-currency-logo mr-1" onerror="this.style.display='none'; document.getElementById('swapToText').classList.remove('hidden');"><span id="swapToText" class="hidden">ZSG</span>
            </span>
        </div>

        <label for="swapAmountInput" id="swapAmountLabel">Amount to Swap (USDT):</label>
        <input type="number" id="swapAmountInput" name="swapAmountInput" placeholder="Enter amount" required min="0.000001">

        <p class="info-text" id="swapBalanceInfo">
            Your USDT Balance: <span id="swapUsdtBalance" class="font-medium">Loading...</span>
            <img id="swapBalanceLogo" src="/images/usdt.png" alt="USDT" class="history-currency-logo" onerror="this.style.display='none';">
        </p>

        <div id="swapRateDisplay" class="rate-display">Current Rate: Loading...</div>

        <label for="receiveAmountDisplay" id="receiveAmountLabel">You will receive (approx. ZSG):</label>
        <input type="text" id="receiveAmountDisplay" name="receiveAmountDisplay" readonly class="bg-gray-800 border-gray-700 cursor-not-allowed">

        <button type="button" id="confirmSwapBtn">Confirm Swap</button>
      </div>
    </div>
  </div>

  <div id="transactionDetailModal" class="modal">
    <div class="modal-content">
      <span class="close-button" id="closeTransactionDetailModalBtn">&times;</span>
      <h2 id="transactionDetailTitle">Transaction Details</h2>
      <div id="transactionDetailContent" class="mt-4">
        </div>
    </div>
  </div>

  <div id="message-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[70] hidden"> <div class="bg-gray-900 text-gray-100 p-6 sm:p-8 rounded-lg border border-gray-700 text-center shadow-2xl min-w-[300px] max-w-md">
      <p id="modal-message-text" class="mb-6 text-lg"></p>
      <button id="modal-close-button" class="px-6 py-2.5 bg-sky-600 hover:bg-sky-700 text-white rounded-md font-semibold transition-colors">Close</button>
    </div>
  </div>

  <footer class="w-full max-w-2xl mx-auto text-center py-8 mt-12 border-t border-gray-800">
    <p class="text-sm text-gray-500">&copy; 2024-2025 GainX by ZYRICCO. All Rights Reserved.</p>
    <p class="text-xs text-gray-600 mt-1">
        ZYRICCO Finance Ltd. 85 Bishopsgate, London EC2N 4AJ. Company Reg: #ZE-5082291
    </p>
    <div class="mt-3">
        <a href="legal.html#terms" class="text-xs text-gray-500 hover:text-sky-400 transition-colors mx-2">Terms</a>
        <span class="text-gray-600">&bull;</span>
        <a href="legal.html#privacy" class="text-xs text-gray-500 hover:text-sky-400 transition-colors mx-2">Privacy</a>
        <span class="text-gray-600">&bull;</span>
        <a href="mailto:support@gainx.ai" class="text-xs text-gray-500 hover:text-sky-400 transition-colors mx-2">Support</a>
    </div>
  </footer>


  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";
    import { getDatabase, ref, onValue, query, serverTimestamp, push, set, get, update } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC9yCEe4a9KC0Ph64gMkrDn_Cfah0TxlMw",
      authDomain: "swiftgain.firebaseapp.com",
      databaseURL: "https://swiftgain-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "swiftgain",
      storageBucket: "swiftgain.firebasestorage.app",
      messagingSenderId: "751911092919",
      appId: "1:751911092919:web:bd0ab90ca8b4432f0d4332"
    };

    let app;
    let auth;
    let database;
    let currentUserId = null;
    let currentZSGValue = 2.98;
    let INR_CONVERSION_RATE = 93.6;
    let currentUserData = null;
    let exchangeRates = null;
    let selectedDisplayCurrency = 'USD';

    const USDT_LOGO_URL = '/images/usdt.png';
    const ZSG_LOGO_URL = '/images/zsg.png';

    // Helper to create image tag with robust fallback for main balance displays
    function createCurrencyHtml(currencyCode, amount, logoClass = 'currency-logo', amountClass = 'text-sm text-gray-400 ml-1') {
        const logoUrl = currencyCode === 'USDT' ? USDT_LOGO_URL : (currencyCode === 'ZSG' ? ZSG_LOGO_URL : null);
        let amountStr = '';
        if (typeof amount === 'number') {
            amountStr = currencyCode === 'ZSG' ? amount.toFixed(4) : amount.toFixed(2);
        } else if (typeof amount === 'string') {
            amountStr = amount; // For "Loading..." or "Error"
        }

        if (logoUrl) {
            // Ensure the span is the immediate next sibling and is initially hidden.
            return `${amountStr}<img src="${logoUrl}" alt="${currencyCode}" class="${logoClass}" onerror="this.style.display='none'; const fe = this.nextElementSibling; if(fe) fe.classList.remove('hidden');"><span class="${amountClass} hidden">${currencyCode}</span>`;
        }
        return `${amountStr}<span class="${amountClass}">${currencyCode}</span>`;
    }

    // Helper to generate currency logo HTML for dynamic strings (history, details)
    function getCurrencyLogoHtml(currencyCode, cssClass = "history-currency-logo") {
        const logoUrl = currencyCode === 'USDT' ? USDT_LOGO_URL : (currencyCode === 'ZSG' ? ZSG_LOGO_URL : null);
        if (logoUrl) {
            return `<img src="${logoUrl}" alt="${currencyCode}" class="${cssClass}" onerror="this.outerHTML='${currencyCode}';">`;
        }
        return currencyCode; // Fallback to text if no logo URL or for other currencies like INR
    }


    const mainHeaderTitleEl = document.getElementById('main-header-title');
    const totalPortfolioValueDisplayEl = document.getElementById('total-portfolio-value-display');
    const usdtBalanceDisplayEl = document.getElementById('usdt-balance-display');
    const zsgBalanceDisplayEl = document.getElementById('zsg-balance-display');
    const currencySelectorEl = document.getElementById('currencySelector');
    // const portfolioCurrencyCodeEl = document.getElementById('portfolio-currency-code'); // Not directly used after initial setup
    const appContainerEl = document.getElementById('app-container');
    const userNoticeBannerEl = document.getElementById('userNoticeBanner');

    const depositFundsBtnEl = document.getElementById('depositFundsBtn');
    const openSwapModalBtnEl = document.getElementById('openSwapModalBtn');
    const openWithdrawModalButtonEl = document.getElementById('openWithdrawModalGainxBtn');

    const messageModalEl = document.getElementById("message-modal");
    const modalMessageTextEl = document.getElementById("modal-message-text");
    const modalCloseButtonEl = document.getElementById("modal-close-button");

    const withdrawalModalEl = document.getElementById('withdrawalModal');
    const closeWithdrawModalBtnEl = document.getElementById('closeWithdrawModalBtn');
    const impsNeftFormEl = document.getElementById('impsNeftForm');
    const usdtTrc20FormEl = document.getElementById('usdtTrc20Form');
    const selectImpsNeftBtnEl = document.getElementById('selectImpsNeftBtn');
    const selectUsdtTrc20BtnEl = document.getElementById('selectUsdtTrc20Btn');
    const withdrawalFullNameInputEl = document.getElementById('withdrawalFullName');
    const withdrawalIfscCodeInputEl = document.getElementById('withdrawalIfscCode');
    const withdrawalAccountNumberInputEl = document.getElementById('withdrawalAccountNumber');
    const withdrawalImpsAmountInputEl = document.getElementById('withdrawalImpsAmount');
    const submitImpsWithdrawalBtnEl = document.getElementById('submitImpsWithdrawalBtn');
    const withdrawalUsdtAmountInputEl = document.getElementById('withdrawalUsdtAmount');
    const withdrawalUsdtAddressInputEl = document.getElementById('withdrawalUsdtAddress');
    const submitUsdtWithdrawalBtnEl = document.getElementById('submitUsdtWithdrawalBtn');

    const swapModalEl = document.getElementById('swapModal');
    const closeSwapModalBtnEl = document.getElementById('closeSwapModalBtn');
    const swapDirectionToggleBtnEl = document.getElementById('swapDirectionToggleBtn');
    const swapFromLogoEl = document.getElementById('swapFromLogo');
    const swapFromTextEl = document.getElementById('swapFromText');
    const swapToLogoEl = document.getElementById('swapToLogo');
    const swapToTextEl = document.getElementById('swapToText');
    const swapAmountInputEl = document.getElementById('swapAmountInput');
    const swapAmountLabelEl = document.getElementById('swapAmountLabel');
    const swapRateDisplayEl = document.getElementById('swapRateDisplay');
    const receiveAmountDisplayEl = document.getElementById('receiveAmountDisplay');
    const receiveAmountLabelEl = document.getElementById('receiveAmountLabel');
    const confirmSwapBtnEl = document.getElementById('confirmSwapBtn');
    const swapUsdtBalanceEl = document.getElementById('swapUsdtBalance');
    const swapBalanceInfoEl = document.getElementById('swapBalanceInfo');
    const swapBalanceLogoEl = document.getElementById('swapBalanceLogo');
    let isSwappingUsdtToZsg = true;

    const transactionHistoryListEl = document.getElementById("transaction-history-list");
    const noTransactionsMessageEl = document.getElementById("no-transactions-message");
    const swapHistoryListEl = document.getElementById("swap-history-list");
    const noSwapsMessageEl = document.getElementById("no-swaps-message");

    const transactionDetailModalEl = document.getElementById('transactionDetailModal');
    const transactionDetailTitleEl = document.getElementById('transactionDetailTitle');
    const transactionDetailContentEl = document.getElementById('transactionDetailContent');
    const closeTransactionDetailModalBtnEl = document.getElementById('closeTransactionDetailModalBtn');

    const userMenuContainerEl = document.getElementById('userMenuContainer');
    const userMenuToggleBtnEl = document.getElementById('userMenuToggleBtn');
    const userDropdownMenuEl = document.getElementById('userDropdownMenu');
    const userMenuEmailEl = document.getElementById('userMenuEmail');
    const changePasswordMenuBtnEl = document.getElementById('changePasswordMenuBtn');
    const logoutMenuBtnEl = document.getElementById('logoutMenuBtn');


    if (modalCloseButtonEl) {
        modalCloseButtonEl.addEventListener("click", () => {
          if(messageModalEl) messageModalEl.classList.add("hidden");
        });
    }
    if (closeTransactionDetailModalBtnEl) {
        closeTransactionDetailModalBtnEl.addEventListener("click", () => {
            if(transactionDetailModalEl) transactionDetailModalEl.style.display = "none";
        });
    }

    function showGenericMessage(message, isError = false) {
        if (modalMessageTextEl && messageModalEl) {
            modalMessageTextEl.textContent = message;
            modalMessageTextEl.className = `mb-6 text-lg font-medium ${isError ? "text-rose-400" : "text-emerald-400"}`;
            messageModalEl.classList.remove("hidden");
        } else {
            console.warn("Message modal elements not found. Logging to console.");
            console.log("MESSAGE:", message);
        }
    }

    function displayUserNotice(message, isCritical = false) {
        if (!userNoticeBannerEl) return;
        if (message && message.trim() !== '') {
            userNoticeBannerEl.textContent = message;
            userNoticeBannerEl.className = 'text-center p-4 mb-6 rounded-md font-medium';
            if (isCritical) {
                userNoticeBannerEl.classList.add('notice-critical');
            } else {
                userNoticeBannerEl.classList.add('notice-info');
            }
            userNoticeBannerEl.style.display = 'block';
        } else {
            userNoticeBannerEl.style.display = 'none';
        }
    }

    async function fetchAndDisplayIpAddress() {
        if (!mainHeaderTitleEl) return;
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            mainHeaderTitleEl.textContent = `Your IP Address: ${data.ip}`;
        } catch (error) {
            console.error("Could not fetch IP address:", error);
            mainHeaderTitleEl.textContent = "IP Address Unavailable";
        }
    }

    async function fetchExchangeRates() {
        try {
            const response = await fetch('https://api.frankfurter.app/latest?from=USD');
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            const data = await response.json();
            exchangeRates = data.rates;
            exchangeRates['USD'] = 1;
            console.log("Exchange rates fetched:", exchangeRates);
            if (currentUserId) updateWalletData(currentUserId);
        } catch (error) {
            console.error("Could not fetch exchange rates:", error);
            if (totalPortfolioValueDisplayEl) {
                 totalPortfolioValueDisplayEl.innerHTML = `<span class="text-red-500 text-sm">Error loading rates.</span> <span class="text-2xl text-gray-400">${selectedDisplayCurrency}</span>`;
            }
        }
    }

    function setInitialLoadingState() {
        fetchAndDisplayIpAddress();
        fetchExchangeRates();
        if (totalPortfolioValueDisplayEl) totalPortfolioValueDisplayEl.innerHTML = `<span class="animate-pulse">Loading...</span> <span id="portfolio-currency-code" class="text-2xl text-gray-400">${selectedDisplayCurrency}</span>`;
        if (usdtBalanceDisplayEl) usdtBalanceDisplayEl.innerHTML = createCurrencyHtml('USDT', '<span class="animate-pulse">0.00</span>');
        if (zsgBalanceDisplayEl) zsgBalanceDisplayEl.innerHTML = createCurrencyHtml('ZSG', '<span class="animate-pulse">0.00</span>');
        if (noTransactionsMessageEl) noTransactionsMessageEl.textContent = "Loading history...";
        if (noSwapsMessageEl) noSwapsMessageEl.textContent = "Loading swap history...";
    }
    setInitialLoadingState();

    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        database = getDatabase(app);
        console.log("Firebase initialized successfully for GainX Wallet page.");

        const zsgValueDbRef = ref(database, 'tokenInfo/currentValue');
        onValue(zsgValueDbRef, (snapshot) => {
            if (snapshot.exists() && typeof snapshot.val() === 'number' && snapshot.val() > 0) {
                currentZSGValue = snapshot.val();
                console.log("ZSG current value (USDT per ZSG) updated from Firebase to:", currentZSGValue);
                updateSwapModalRateDisplay();
                if (currentUserId) updateWalletData(currentUserId);
            } else {
                console.warn(`Using current/default ZSG value (${currentZSGValue}). Firebase value at 'tokenInfo/currentValue' not found or invalid.`);
            }
        }, (error) => {
            console.error("Error fetching ZSG value from Firebase. Using current/default. Error:", error);
        });

        const inrRateDbRef = ref(database, 'globals/conversionRates/USDT_INR');
        onValue(inrRateDbRef, (snapshot) => {
            const newRate = snapshot.val();
            if (snapshot.exists() && typeof newRate === 'number' && newRate > 0) {
                if (INR_CONVERSION_RATE !== newRate) {
                    INR_CONVERSION_RATE = newRate;
                    console.log("INR_CONVERSION_RATE updated from Firebase to:", INR_CONVERSION_RATE);
                    if (currentUserId && selectedDisplayCurrency === 'INR') {
                        updateWalletData(currentUserId);
                    }
                }
            } else {
                console.warn(`Using current/default INR_CONVERSION_RATE (${INR_CONVERSION_RATE}). Firebase value at 'globals/conversionRates/USDT_INR' not found, invalid, or not a positive number.`);
            }
        }, (error) => {
            console.error("Error fetching INR_CONVERSION_RATE from Firebase. Using current/default rate. Error:", error);
        });

    } catch (error) {
        console.error("Firebase initialization error on GainX Wallet page:", error);
        if (appContainerEl) {
            appContainerEl.innerHTML = '<div class="text-center p-10"><h1 class="text-2xl font-semibold text-red-500">Service Connection Error</h1><p class="text-gray-400 mt-2">Could not connect to the required services. Please try again later.</p></div>';
        }
    }

    function updateWalletData(userId) {
      const userRef = ref(database, `users/${userId}`);
      onValue(userRef, (userDataSnapshot) => {
        if (userDataSnapshot.exists()) {
          currentUserData = userDataSnapshot.val();
          const usdtBalance = parseFloat(currentUserData.usdtBalance) || 0;
          const zsgTokenQty = parseFloat(currentUserData.zsgTokenBalance) || 0;
          const zsgHoldingsInUSDT = zsgTokenQty * currentZSGValue;

          if (currentUserData.isAccessBlocked) {
              if (appContainerEl) appContainerEl.style.display = 'none';
              displayUserNotice(currentUserData.blockReason || "Your account access has been temporarily suspended. Please contact support.", true);
              if(depositFundsBtnEl) depositFundsBtnEl.disabled = true;
              if(openSwapModalBtnEl) openSwapModalBtnEl.disabled = true;
              if(openWithdrawModalButtonEl) openWithdrawModalButtonEl.disabled = true;
              return;
          } else {
              if (appContainerEl) appContainerEl.style.display = 'block';
              if (currentUserData.userNotice && currentUserData.userNotice.trim() !== '') {
                  displayUserNotice(currentUserData.userNotice, false);
              } else {
                  if (userNoticeBannerEl) userNoticeBannerEl.style.display = 'none';
              }
          }

          if (openWithdrawModalButtonEl) {
            openWithdrawModalButtonEl.disabled = !!currentUserData.isWithdrawalBlocked;
            openWithdrawModalButtonEl.title = currentUserData.isWithdrawalBlocked ? "Withdrawals are currently blocked for your account." : "";
            openWithdrawModalButtonEl.classList.toggle('opacity-50', !!currentUserData.isWithdrawalBlocked);
            openWithdrawModalButtonEl.classList.toggle('cursor-not-allowed', !!currentUserData.isWithdrawalBlocked);
          }
          if(depositFundsBtnEl) depositFundsBtnEl.disabled = false;
          if(openSwapModalBtnEl) {
            openSwapModalBtnEl.disabled = !!currentUserData.isWithdrawalBlocked;
            openSwapModalBtnEl.classList.toggle('opacity-50', !!currentUserData.isWithdrawalBlocked);
            openSwapModalBtnEl.classList.toggle('cursor-not-allowed', !!currentUserData.isWithdrawalBlocked);
          }

          let portfolioValueUSD = usdtBalance + zsgHoldingsInUSDT;
          let displayValue = portfolioValueUSD;
          let displayCurrency = 'USD';

          if (selectedDisplayCurrency === 'INR') {
              displayValue = portfolioValueUSD * INR_CONVERSION_RATE;
              displayCurrency = 'INR';
          } else if (selectedDisplayCurrency !== 'USD' && exchangeRates && exchangeRates[selectedDisplayCurrency]) {
              displayValue = portfolioValueUSD * exchangeRates[selectedDisplayCurrency];
              displayCurrency = selectedDisplayCurrency;
          } else if (selectedDisplayCurrency !== 'USD') {
              console.warn(`Exchange rate for ${selectedDisplayCurrency} not available. Displaying in USD.`);
          }

          if (totalPortfolioValueDisplayEl) {
            const portfolioCurrencyCodeEl = document.getElementById('portfolio-currency-code');
            totalPortfolioValueDisplayEl.childNodes[0].textContent = `${displayValue.toFixed(2)} `;
            if(portfolioCurrencyCodeEl) portfolioCurrencyCodeEl.textContent = displayCurrency;
          }

          if (zsgBalanceDisplayEl) zsgBalanceDisplayEl.innerHTML = createCurrencyHtml('ZSG', zsgTokenQty);
          if (usdtBalanceDisplayEl) usdtBalanceDisplayEl.innerHTML = createCurrencyHtml('USDT', usdtBalance);

          if (swapModalEl && swapModalEl.style.display === "block") {
            updateSwapModalBalances();
          }

        } else {
          currentUserData = null;
          console.log("No user data available for wallet:", userId);
          if (totalPortfolioValueDisplayEl) totalPortfolioValueDisplayEl.innerHTML = `0.00 <span id="portfolio-currency-code" class="text-2xl text-gray-400">${selectedDisplayCurrency}</span>`;
          if (zsgBalanceDisplayEl) zsgBalanceDisplayEl.innerHTML = createCurrencyHtml('ZSG', 0);
          if (usdtBalanceDisplayEl) usdtBalanceDisplayEl.innerHTML = createCurrencyHtml('USDT', 0);
        }
      }, (error) => {
        currentUserData = null;
        console.error("Error fetching user wallet data:", error);
        if (totalPortfolioValueDisplayEl) totalPortfolioValueDisplayEl.innerHTML = `Error <span id="portfolio-currency-code" class="text-2xl text-gray-400">${selectedDisplayCurrency}</span>`;
        if (zsgBalanceDisplayEl) zsgBalanceDisplayEl.innerHTML = createCurrencyHtml('ZSG', 'Error');
        if (usdtBalanceDisplayEl) usdtBalanceDisplayEl.innerHTML = createCurrencyHtml('USDT', 'Error');
      });
    }

    if (currencySelectorEl) {
        currencySelectorEl.addEventListener('change', function() {
            selectedDisplayCurrency = this.value;
            const portfolioCurrencyCodeSpan = document.getElementById('portfolio-currency-code');
            if (portfolioCurrencyCodeSpan) portfolioCurrencyCodeSpan.textContent = selectedDisplayCurrency;
            if (currentUserId) updateWalletData(currentUserId);
            else if (totalPortfolioValueDisplayEl) totalPortfolioValueDisplayEl.innerHTML = `0.00 <span id="portfolio-currency-code" class="text-2xl text-gray-400">${selectedDisplayCurrency}</span>`;
        });
    }

    function formatFirebaseTimestamp(timestamp) {
        if (!timestamp) return 'N/A';
        if (typeof timestamp === 'object' && timestamp.hasOwnProperty('.sv')) return 'Processing...';
        try {
            return new Date(timestamp).toLocaleString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: 'numeric', minute: '2-digit', hour12: true
            });
        } catch (e) {
            console.error("Error formatting timestamp:", e);
            return 'Invalid Date';
        }
    }

    function showTransactionDetails(txData, type) {
        if (!transactionDetailModalEl || !transactionDetailTitleEl || !transactionDetailContentEl) return;
        transactionDetailTitleEl.textContent = `${type} Details`;
        let detailsHtml = '<dl class="detail-grid">';

        if (type === 'Withdrawal') {
            const usdtEquivalentDisplay = txData.usdtEquivalentDeducted ? `${txData.usdtEquivalentDeducted?.toFixed(2)} ${getCurrencyLogoHtml('USDT')}` : 'N/A';
            detailsHtml += `<dt>Transaction ID:</dt><dd>${txData.id}</dd>`;
            detailsHtml += `<dt>Date:</dt><dd>${formatFirebaseTimestamp(txData.requestedAt)}</dd>`;
            detailsHtml += `<dt>Amount:</dt><dd>${parseFloat(txData.amount).toFixed(2)} ${getCurrencyLogoHtml(txData.currency)}</dd>`;
            detailsHtml += `<dt>Method:</dt><dd>${txData.method}</dd>`;
            detailsHtml += `<dt>Status:</dt><dd class="capitalize ${'tx-status-' + (txData.status?.toLowerCase() || 'unknown')}">${txData.status}</dd>`;
            if (txData.method === 'IMPS/NEFT') {
                detailsHtml += `<dt>To Account Name:</dt><dd>${txData.fullName || 'N/A'}</dd>`;
                detailsHtml += `<dt>IFSC Code:</dt><dd>${txData.ifscCode || 'N/A'}</dd>`;
                detailsHtml += `<dt>Account Number:</dt><dd>${txData.accountNumber || 'N/A'}</dd>`;
                detailsHtml += `<dt>USDT Deducted:</dt><dd>${usdtEquivalentDisplay}</dd>`;
                if (txData.conversionRateSnapshot) detailsHtml += `<dt>Rate (USDT/INR):</dt><dd>${txData.conversionRateSnapshot}</dd>`;
            } else if (txData.method === 'USDT') {
                detailsHtml += `<dt>To Address:</dt><dd>${txData.usdtAddress || 'N/A'}</dd>`;
            }
        } else if (type === 'Swap') {
            const rateDisplay = txData.rateSnapshot ? `1 ${getCurrencyLogoHtml('ZSG')} = ${txData.rateSnapshot?.toFixed(4)} ${getCurrencyLogoHtml('USDT')}` : 'N/A';
            detailsHtml += `<dt>Transaction ID:</dt><dd>${txData.id}</dd>`;
            detailsHtml += `<dt>Date:</dt><dd>${formatFirebaseTimestamp(txData.swappedAt)}</dd>`;
            detailsHtml += `<dt>Swapped:</dt><dd>${parseFloat(txData.amountSwapped).toFixed(txData.fromCurrency === 'USDT' ? 2 : 4)} ${getCurrencyLogoHtml(txData.fromCurrency)}</dd>`;
            detailsHtml += `<dt>Received:</dt><dd>${parseFloat(txData.amountReceived).toFixed(txData.toCurrency === 'USDT' ? 2 : 4)} ${getCurrencyLogoHtml(txData.toCurrency)}</dd>`;
            detailsHtml += `<dt>Rate:</dt><dd>${rateDisplay}</dd>`;
            detailsHtml += `<dt>Status:</dt><dd class="capitalize ${'tx-status-' + (txData.status?.toLowerCase() || 'unknown')}">${txData.status}</dd>`;
        }
        detailsHtml += '</dl>';
        transactionDetailContentEl.innerHTML = detailsHtml;
        transactionDetailModalEl.style.display = "block";
    }

    function displayTransactionHistory(userId) {
        const userTransactionsRef = query(ref(database, `withdrawalRequests/${userId}`));
        onValue(userTransactionsRef, (snapshot) => {
            if (!transactionHistoryListEl || !noTransactionsMessageEl) return;
            transactionHistoryListEl.innerHTML = '';
            if (snapshot.exists()) {
                noTransactionsMessageEl.style.display = 'none';
                let transactions = [];
                snapshot.forEach(childSnapshot => {
                    const data = childSnapshot.val();
                    // Robustness: Ensure data is an object before spreading
                    if (data && typeof data === 'object') {
                        transactions.push({ id: childSnapshot.key, ...data });
                    } else {
                        console.warn("Skipping invalid transaction data in withdrawalRequests:", childSnapshot.key, data);
                    }
                });
                transactions.sort((a, b) => (b.requestedAt || 0) - (a.requestedAt || 0));

                transactions.forEach(tx => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'transaction-item';
                    const statusClass = `tx-status-${tx.status?.toLowerCase() || 'unknown'}`;
                    const typeCurrencyDisplay = getCurrencyLogoHtml(tx.currency);
                    const amountCurrencyDisplay = getCurrencyLogoHtml(tx.currency);

                    itemEl.innerHTML = `
                        <div class="transaction-details">
                            <p class="font-medium text-gray-100 tx-type-withdrawal">
                                ${tx.method} Withdrawal (${typeCurrencyDisplay})
                            </p>
                            <p class="text-xs text-gray-500">${formatFirebaseTimestamp(tx.requestedAt)}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold text-base tx-type-withdrawal">
                                -${parseFloat(tx.amount).toFixed(2)} ${amountCurrencyDisplay}
                            </p>
                            <p class="text-xs ${statusClass} capitalize">${tx.status}</p>
                        </div>
                    `;
                    itemEl.addEventListener('click', () => showTransactionDetails(tx, 'Withdrawal'));
                    transactionHistoryListEl.appendChild(itemEl);
                });
            } else {
                noTransactionsMessageEl.textContent = 'No withdrawal history found.';
                noTransactionsMessageEl.style.display = 'block';
            }
        }, (error) => {
            console.error("Error fetching transaction history:", error);
            if (noTransactionsMessageEl) {
                noTransactionsMessageEl.textContent = 'Could not load transaction history.';
                noTransactionsMessageEl.style.display = 'block';
            }
        });
    }

    function displaySwapHistory(userId) {
        const userSwapsRef = query(ref(database, `swapRequests/${userId}`));
        onValue(userSwapsRef, (snapshot) => {
            if (!swapHistoryListEl || !noSwapsMessageEl) return;
            swapHistoryListEl.innerHTML = '';
            if (snapshot.exists()) {
                noSwapsMessageEl.style.display = 'none';
                let swaps = [];
                snapshot.forEach(childSnapshot => {
                    const data = childSnapshot.val();
                    // Robustness: Ensure data is an object before spreading
                    if (data && typeof data === 'object') {
                        swaps.push({ id: childSnapshot.key, ...data });
                    } else {
                        console.warn("Skipping invalid swap data in swapRequests:", childSnapshot.key, data);
                    }
                });
                swaps.sort((a, b) => (b.swappedAt || 0) - (a.swappedAt || 0));

                swaps.forEach(swap => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'transaction-item';
                    const fromCurrencyHtml = getCurrencyLogoHtml(swap.fromCurrency);
                    const toCurrencyHtml = getCurrencyLogoHtml(swap.toCurrency);

                    itemEl.innerHTML = `
                        <div class="transaction-details">
                            <p class="font-medium text-gray-100 tx-type-swap">
                                Swap ${fromCurrencyHtml} to ${toCurrencyHtml}
                            </p>
                            <p class="text-xs text-gray-500">${formatFirebaseTimestamp(swap.swappedAt)}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold text-sm text-gray-300">
                                <span class="text-red-500">-${parseFloat(swap.amountSwapped).toFixed(swap.fromCurrency === 'USDT' ? 2 : 4)} ${fromCurrencyHtml}</span>
                            </p>
                             <p class="font-semibold text-sm text-gray-300 mt-1">
                                <span class="text-green-500">+${parseFloat(swap.amountReceived).toFixed(swap.toCurrency === 'USDT' ? 2 : 4)} ${toCurrencyHtml}</span>
                            </p>
                        </div>
                    `;
                    itemEl.addEventListener('click', () => showTransactionDetails(swap, 'Swap'));
                    swapHistoryListEl.appendChild(itemEl);
                });
            } else {
                noSwapsMessageEl.textContent = 'No swap history found.';
                noSwapsMessageEl.style.display = 'block';
            }
        }, (error) => {
            console.error("Error fetching swap history:", error);
            if (noSwapsMessageEl) {
                noSwapsMessageEl.textContent = 'Could not load swap history.';
                noSwapsMessageEl.style.display = 'block';
            }
        });
    }

    if (userMenuToggleBtnEl && userDropdownMenuEl && userMenuContainerEl) {
        userMenuToggleBtnEl.addEventListener('click', (event) => {
            event.stopPropagation();
            userDropdownMenuEl.classList.toggle('hidden');
        });
        document.addEventListener('click', (event) => {
            if (!userMenuContainerEl.contains(event.target) && !userDropdownMenuEl.classList.contains('hidden')) {
                userDropdownMenuEl.classList.add('hidden');
            }
        });
    }

    if (logoutMenuBtnEl) {
        logoutMenuBtnEl.addEventListener('click', async () => {
            if (!auth) { showGenericMessage("Authentication service not available.", true); return; }
            try {
                await signOut(auth);
                showGenericMessage("You have been successfully logged out.", false);
                if (userDropdownMenuEl) userDropdownMenuEl.classList.add('hidden');
            } catch (error) {
                console.error("Logout Error:", error);
                showGenericMessage("Logout failed: " + error.message, true);
            }
        });
    }

    if (changePasswordMenuBtnEl) {
        changePasswordMenuBtnEl.addEventListener('click', async () => {
            if (!auth || !auth.currentUser) { showGenericMessage("You must be logged in to change your password.", true); return; }
            const userEmail = auth.currentUser.email;
            if (!userEmail) { showGenericMessage("Your email address is not available. Cannot send password reset link.", true); return; }
            try {
                await sendPasswordResetEmail(auth, userEmail);
                showGenericMessage(`A password reset link has been sent to ${userEmail}. Please check your inbox.`, false);
                if (userDropdownMenuEl) userDropdownMenuEl.classList.add('hidden');
            } catch (error) {
                console.error("Send Password Reset Email Error:", error);
                showGenericMessage("Failed to send password reset email: " + error.message, true);
            }
        });
    }

    if (auth && database) {
        onAuthStateChanged(auth, (user) => {
          const authStatusEl = document.getElementById("auth-status");
          const userIdDisplayEl = document.getElementById("user-id-display");
          if (user) {
            currentUserId = user.uid;
            if (authStatusEl) authStatusEl.textContent = `Logged in: ${user.email || 'Authenticated User'}`;
            if (userIdDisplayEl) userIdDisplayEl.textContent = `User ID: ${user.uid}`;
            updateWalletData(currentUserId);
            displayTransactionHistory(currentUserId);
            displaySwapHistory(currentUserId);
            if (userMenuToggleBtnEl) userMenuToggleBtnEl.classList.remove('hidden');
            if (userMenuEmailEl) userMenuEmailEl.textContent = user.email || 'N/A';
          } else {
            currentUserId = null; currentUserData = null;
            if (authStatusEl) authStatusEl.textContent = 'Not Authenticated. Please log in.';
            if (userIdDisplayEl) userIdDisplayEl.textContent = 'User ID: -';
            setInitialLoadingState();
            if (noTransactionsMessageEl) { noTransactionsMessageEl.textContent = 'Please log in to view transaction history.'; noTransactionsMessageEl.style.display = 'block';}
            if (transactionHistoryListEl) transactionHistoryListEl.innerHTML = '';
            if (noSwapsMessageEl) { noSwapsMessageEl.textContent = 'Please log in to view swap history.'; noSwapsMessageEl.style.display = 'block'; }
            if (swapHistoryListEl) swapHistoryListEl.innerHTML = '';
            if (userNoticeBannerEl) userNoticeBannerEl.style.display = 'none';
            if (appContainerEl) appContainerEl.style.display = 'block';
            if (userMenuToggleBtnEl) userMenuToggleBtnEl.classList.add('hidden');
            if (userDropdownMenuEl) userDropdownMenuEl.classList.add('hidden');
            if (userMenuEmailEl) userMenuEmailEl.textContent = 'Loading...';
            if(depositFundsBtnEl) depositFundsBtnEl.disabled = false;
            if(openSwapModalBtnEl) { openSwapModalBtnEl.disabled = false; openSwapModalBtnEl.classList.remove('opacity-50', 'cursor-not-allowed'); }
            if(openWithdrawModalButtonEl) { openWithdrawModalButtonEl.disabled = false; openWithdrawModalButtonEl.classList.remove('opacity-50', 'cursor-not-allowed'); }
          }
        });
    } else {
        console.error("Firebase auth or database is not available.");
        if (appContainerEl) appContainerEl.innerHTML = '<div class="text-center p-10"><h1 class="text-2xl font-semibold text-red-500">Critical Error</h1><p class="text-gray-400 mt-2">Core services unavailable.</p></div>';
    }

    if (openWithdrawModalButtonEl && withdrawalModalEl) {
        openWithdrawModalButtonEl.onclick = function() {
            if (!currentUserId) { showGenericMessage("Please log in to withdraw funds.", true); return; }
            if (currentUserData && currentUserData.isWithdrawalBlocked) { showGenericMessage("Withdrawals are currently disabled for your account.", true); return; }
            withdrawalModalEl.style.display = "block";
            if(impsNeftFormEl) impsNeftFormEl.style.display = "block";
            if(usdtTrc20FormEl) usdtTrc20FormEl.style.display = "none";
            if(selectImpsNeftBtnEl) selectImpsNeftBtnEl.classList.add('active');
            if(selectUsdtTrc20BtnEl) selectUsdtTrc20BtnEl.classList.remove('active');
            if(withdrawalImpsAmountInputEl) withdrawalImpsAmountInputEl.value = '';
            if(withdrawalUsdtAmountInputEl) withdrawalUsdtAmountInputEl.value = '';
            if(withdrawalUsdtAddressInputEl) withdrawalUsdtAddressInputEl.value = '';
            const userBankDetailsRef = ref(database, `users/${currentUserId}/bankDetails`);
            get(userBankDetailsRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const bankDetails = snapshot.val();
                    if(withdrawalFullNameInputEl) withdrawalFullNameInputEl.value = bankDetails.fullName || '';
                    if(withdrawalIfscCodeInputEl) withdrawalIfscCodeInputEl.value = bankDetails.ifscCode || '';
                    if(withdrawalAccountNumberInputEl) withdrawalAccountNumberInputEl.value = bankDetails.accountNumber || '';
                } else {
                    if(withdrawalFullNameInputEl) withdrawalFullNameInputEl.value = '';
                    if(withdrawalIfscCodeInputEl) withdrawalIfscCodeInputEl.value = '';
                    if(withdrawalAccountNumberInputEl) withdrawalAccountNumberInputEl.value = '';
                }
            }).catch(error => {
                console.error("Error fetching bank details:", error);
                if(withdrawalFullNameInputEl) withdrawalFullNameInputEl.value = '';
                if(withdrawalIfscCodeInputEl) withdrawalIfscCodeInputEl.value = '';
                if(withdrawalAccountNumberInputEl) withdrawalAccountNumberInputEl.value = '';
            });
        }
    }
    if (closeWithdrawModalBtnEl && withdrawalModalEl) closeWithdrawModalBtnEl.onclick = function() { withdrawalModalEl.style.display = "none"; }
    window.addEventListener('click', function(event) {
        if (event.target == withdrawalModalEl && withdrawalModalEl) withdrawalModalEl.style.display = "none";
        if (event.target == swapModalEl && swapModalEl) swapModalEl.style.display = "none";
        if (event.target == transactionDetailModalEl && transactionDetailModalEl) transactionDetailModalEl.style.display = "none";
    });

    if (selectImpsNeftBtnEl && selectUsdtTrc20BtnEl && impsNeftFormEl && usdtTrc20FormEl) {
        selectImpsNeftBtnEl.onclick = function() {
            impsNeftFormEl.style.display = "block"; usdtTrc20FormEl.style.display = "none";
            selectImpsNeftBtnEl.classList.add('active'); selectUsdtTrc20BtnEl.classList.remove('active');
        }
        selectUsdtTrc20BtnEl.onclick = function() {
            impsNeftFormEl.style.display = "none"; usdtTrc20FormEl.style.display = "block";
            selectUsdtTrc20BtnEl.classList.add('active'); selectImpsNeftBtnEl.classList.remove('active');
        }
    }
    async function handleWithdrawal(amount, method, details) {
        if (!currentUserId) { showGenericMessage("User not authenticated.", true); return; }
        if (currentUserData && currentUserData.isWithdrawalBlocked) { showGenericMessage("Withdrawals are currently disabled.", true); return; }
        const parsedAmount = parseFloat(amount);
        if (isNaN(parsedAmount) || parsedAmount <= 0) { showGenericMessage("Amount must be positive.", true); return; }
        const submitButton = method === 'IMPS/NEFT' ? submitImpsWithdrawalBtnEl : submitUsdtWithdrawalBtnEl;
        const originalButtonText = submitButton.textContent;
        submitButton.disabled = true;
        submitButton.innerHTML = `<span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>Processing...`;
        try {
            const userRef = ref(database, `users/${currentUserId}`);
            const userSnapshot = await get(userRef);
            if (!userSnapshot.exists()) throw new Error("User data not found.");
            const userData = userSnapshot.val();
            let withdrawalAvailableUsdt = parseFloat(userData.withdrawalAvailable !== undefined ? userData.withdrawalAvailable : userData.usdtBalance) || 0;
            let usdtEquivalentDeducted;

            if (method === 'IMPS/NEFT') {
                usdtEquivalentDeducted = parsedAmount / INR_CONVERSION_RATE;
                if (usdtEquivalentDeducted > withdrawalAvailableUsdt) throw new Error(`Insufficient balance. Need ${usdtEquivalentDeducted.toFixed(2)} USDT.`);
                const currentBankDetails = { fullName: details.fullName, ifscCode: details.ifscCode, accountNumber: details.accountNumber };
                if (!userData.bankDetails || JSON.stringify(userData.bankDetails) !== JSON.stringify(currentBankDetails)) {
                    await update(ref(database, `users/${currentUserId}/bankDetails`), currentBankDetails);
                }
            } else if (method === 'USDT') {
                usdtEquivalentDeducted = parsedAmount;
                if (usdtEquivalentDeducted > withdrawalAvailableUsdt) throw new Error("Insufficient USDT balance.");
            } else throw new Error("Invalid withdrawal method.");

            const newCombinedBalance = withdrawalAvailableUsdt - usdtEquivalentDeducted;
            const withdrawalRequestRef = push(ref(database, `withdrawalRequests/${currentUserId}`));
            const withdrawalData = {
                userId: currentUserId, amount: parsedAmount, currency: method === 'IMPS/NEFT' ? 'INR' : 'USDT',
                usdtEquivalentDeducted: parseFloat(usdtEquivalentDeducted.toFixed(2)), method: method, status: 'Pending',
                requestedAt: serverTimestamp(), conversionRateSnapshot: method === 'IMPS/NEFT' ? INR_CONVERSION_RATE : null,
                ...(method === 'IMPS/NEFT' && { fullName: details.fullName, ifscCode: details.ifscCode, accountNumber: details.accountNumber }),
                ...(method === 'USDT' && { usdtAddress: details.usdtAddress })
            };
            await set(withdrawalRequestRef, withdrawalData);
            const updates = { usdtBalance: parseFloat(newCombinedBalance.toFixed(2)) };
            if (userData.withdrawalAvailable !== undefined) updates.withdrawalAvailable = parseFloat(newCombinedBalance.toFixed(2));
            await update(userRef, updates);
            showGenericMessage(`Withdrawal for ${parsedAmount} ${withdrawalData.currency} submitted.`, false);
            if(withdrawalModalEl) withdrawalModalEl.style.display = "none";
        } catch (error) {
            console.error("Withdrawal error:", error);
            showGenericMessage("Withdrawal failed: " + error.message, true);
        } finally {
            if (submitButton) { submitButton.disabled = false; submitButton.innerHTML = originalButtonText; }
        }
    }
    if (submitImpsWithdrawalBtnEl) {
        submitImpsWithdrawalBtnEl.onclick = function() {
            const fullName = withdrawalFullNameInputEl.value.trim();
            const ifscCode = withdrawalIfscCodeInputEl.value.trim().toUpperCase();
            const accountNumber = withdrawalAccountNumberInputEl.value.trim();
            const amountInrStr = withdrawalImpsAmountInputEl.value;
            if (!fullName || !ifscCode || !accountNumber || !amountInrStr) { showGenericMessage("Please fill all IMPS/NEFT fields.", true); return; }
            if (!/^[A-Z]{4}0[A-Z0-9]{6}$/.test(ifscCode)) { showGenericMessage("Invalid IFSC. Ex: SBIN0001234.", true); return; }
            if (!/^\d{9,18}$/.test(accountNumber)) { showGenericMessage("Invalid account number (9-18 digits).", true); return; }
            handleWithdrawal(amountInrStr, 'IMPS/NEFT', { fullName, ifscCode, accountNumber });
        };
    }
    if (submitUsdtWithdrawalBtnEl) {
        submitUsdtWithdrawalBtnEl.onclick = function() {
            const amountUsdtStr = withdrawalUsdtAmountInputEl.value;
            const usdtAddress = withdrawalUsdtAddressInputEl.value.trim();
            if (!amountUsdtStr || !usdtAddress) { showGenericMessage("Please fill all USDT-TRC20 fields.", true); return; }
            if (!/^T[1-9A-HJ-NP-Za-km-z]{33}$/.test(usdtAddress)) { showGenericMessage("Invalid USDT TRC20 address.", true); return; }
            handleWithdrawal(amountUsdtStr, 'USDT', { usdtAddress });
        };
    }

    function updateSwapModalRateDisplay() {
        if (swapRateDisplayEl) {
            swapRateDisplayEl.innerHTML = `Current Rate: 1 ${getCurrencyLogoHtml('ZSG')} = ${currentZSGValue.toFixed(4)} ${getCurrencyLogoHtml('USDT')}`;
        }
        calculateSwapReceiveAmount();
    }

    function updateSwapModalBalances() {
        if (!currentUserData || !swapBalanceInfoEl || !swapBalanceLogoEl || !swapUsdtBalanceEl) return;
        const usdtBal = parseFloat(currentUserData.usdtBalance) || 0;
        const zsgTokenQty = parseFloat(currentUserData.zsgTokenBalance) || 0;
        const balanceTextPrefix = isSwappingUsdtToZsg ? "Your USDT Balance: " : "Your ZSG Balance: ";
        const balanceAmount = isSwappingUsdtToZsg ? usdtBal.toFixed(2) : zsgTokenQty.toFixed(4);
        const balanceLogoSrc = isSwappingUsdtToZsg ? USDT_LOGO_URL : ZSG_LOGO_URL;
        const balanceLogoAlt = isSwappingUsdtToZsg ? "USDT" : "ZSG";

        swapBalanceInfoEl.childNodes[0].textContent = balanceTextPrefix;
        swapUsdtBalanceEl.textContent = balanceAmount;
        swapBalanceLogoEl.src = balanceLogoSrc;
        swapBalanceLogoEl.alt = balanceLogoAlt;
        swapBalanceLogoEl.onerror = function() { this.style.display='none'; this.insertAdjacentHTML('afterend', `<span class="history-currency-logo">${balanceLogoAlt}</span>`); this.remove(); };
    }

    function calculateSwapReceiveAmount() {
        if (!swapAmountInputEl || !receiveAmountDisplayEl || currentZSGValue <= 0) {
            if (receiveAmountDisplayEl) receiveAmountDisplayEl.value = '0.00'; return;
        }
        const amountToSwap = parseFloat(swapAmountInputEl.value);
        if (isNaN(amountToSwap) || amountToSwap <= 0) {
            receiveAmountDisplayEl.value = '0.00'; return;
        }
        const amountToReceive = isSwappingUsdtToZsg ? (amountToSwap / currentZSGValue) : (amountToSwap * currentZSGValue);
        receiveAmountDisplayEl.value = isSwappingUsdtToZsg ? amountToReceive.toFixed(4) : amountToReceive.toFixed(2);
    }

    function setupSwapModal() {
        if (!swapAmountLabelEl || !receiveAmountLabelEl || !swapFromLogoEl || !swapToLogoEl || !swapFromTextEl || !swapToTextEl) return;
        const fromCoin = isSwappingUsdtToZsg ? 'USDT' : 'ZSG';
        const toCoin = isSwappingUsdtToZsg ? 'ZSG' : 'USDT';
        swapFromLogoEl.src = fromCoin === 'USDT' ? USDT_LOGO_URL : ZSG_LOGO_URL;
        swapFromLogoEl.alt = fromCoin;
        swapFromTextEl.textContent = fromCoin;
        swapToLogoEl.src = toCoin === 'USDT' ? USDT_LOGO_URL : ZSG_LOGO_URL;
        swapToLogoEl.alt = toCoin;
        swapToTextEl.textContent = toCoin;

        // Ensure logos are visible and text fallbacks are hidden initially
        swapFromLogoEl.style.display = 'inline-block'; swapFromTextEl.classList.add('hidden');
        swapToLogoEl.style.display = 'inline-block'; swapToTextEl.classList.add('hidden');

        swapAmountLabelEl.innerHTML = `Amount to Swap (${getCurrencyLogoHtml(fromCoin, 'history-currency-logo')}):`;
        receiveAmountLabelEl.innerHTML = `You will receive (approx. ${getCurrencyLogoHtml(toCoin, 'history-currency-logo')}):`;

        swapFromLogoEl.onerror = () => { swapFromLogoEl.style.display='none'; swapFromTextEl.classList.remove('hidden'); };
        swapToLogoEl.onerror = () => { swapToLogoEl.style.display='none'; swapToTextEl.classList.remove('hidden'); };

        updateSwapModalBalances();
        calculateSwapReceiveAmount();
        updateSwapModalRateDisplay();
    }

    if (openSwapModalBtnEl && swapModalEl) {
        openSwapModalBtnEl.onclick = function() {
            if (!currentUserId) { showGenericMessage("Please log in to swap tokens.", true); return; }
            if (currentUserData && currentUserData.isWithdrawalBlocked) { showGenericMessage("Swaps are currently disabled.", true); return; }
            if (currentZSGValue <= 0) { showGenericMessage("Swap rate unavailable.", true); return; }
            isSwappingUsdtToZsg = true;
            if(swapAmountInputEl) swapAmountInputEl.value = '';
            if(receiveAmountDisplayEl) receiveAmountDisplayEl.value = '';
            setupSwapModal();
            swapModalEl.style.display = "block";
        }
    }
    if (closeSwapModalBtnEl && swapModalEl) closeSwapModalBtnEl.onclick = function() { swapModalEl.style.display = "none"; }
    if (swapDirectionToggleBtnEl) {
        swapDirectionToggleBtnEl.onclick = function() {
            isSwappingUsdtToZsg = !isSwappingUsdtToZsg;
            setupSwapModal();
        }
    }
    if (swapAmountInputEl) swapAmountInputEl.addEventListener('input', calculateSwapReceiveAmount);

    async function handleSwap() {
        if (!currentUserId || !currentUserData) { showGenericMessage("User not authenticated or data not loaded.", true); return; }
        if (currentUserData.isWithdrawalBlocked) { showGenericMessage("Swaps are currently disabled.", true); return; }
        if (currentZSGValue <= 0) { showGenericMessage("Swap rate unavailable.", true); return; }
        const amountToSwap = parseFloat(swapAmountInputEl.value);
        if (isNaN(amountToSwap) || amountToSwap <= 0) { showGenericMessage("Enter a valid positive amount to swap.", true); return; }

        const originalButtonText = confirmSwapBtnEl.textContent;
        confirmSwapBtnEl.disabled = true;
        confirmSwapBtnEl.innerHTML = `<span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>Processing...`;
        try {
            const userRef = ref(database, `users/${currentUserId}`);
            const latestUserSnapshot = await get(userRef);
            if (!latestUserSnapshot.exists()) throw new Error("User data not found.");
            const latestUserData = latestUserSnapshot.val();
            let currentUsdtBalance = parseFloat(latestUserData.usdtBalance) || 0;
            let currentZsgTokenBalance = parseFloat(latestUserData.zsgTokenBalance) || 0;
            let newUsdtBalance, newZsgTokenBalance, amountReceived;

            if (isSwappingUsdtToZsg) { // USDT to ZSG
                if (amountToSwap > currentUsdtBalance) throw new Error("Insufficient USDT balance.");
                amountReceived = amountToSwap / currentZSGValue;
                newUsdtBalance = currentUsdtBalance - amountToSwap;
                newZsgTokenBalance = currentZsgTokenBalance + amountReceived;
            } else { // ZSG to USDT
                if (amountToSwap > currentZsgTokenBalance) throw new Error(`Insufficient ZSG. You have ${currentZsgTokenBalance.toFixed(4)} ZSG.`);
                amountReceived = amountToSwap * currentZSGValue;
                newUsdtBalance = currentUsdtBalance + amountReceived;
                newZsgTokenBalance = currentZsgTokenBalance - amountToSwap;
            }
            const balanceUpdates = {
                usdtBalance: parseFloat(newUsdtBalance.toFixed(2)),
                zsgTokenBalance: parseFloat(newZsgTokenBalance.toFixed(4))
            };
            if (latestUserData.withdrawalAvailable !== undefined) balanceUpdates.withdrawalAvailable = parseFloat(newUsdtBalance.toFixed(2));
            await update(userRef, balanceUpdates);
            const swapRequestRef = push(ref(database, `swapRequests/${currentUserId}`));
            await set(swapRequestRef, {
                userId: currentUserId, fromCurrency: isSwappingUsdtToZsg ? 'USDT' : 'ZSG', toCurrency: isSwappingUsdtToZsg ? 'ZSG' : 'USDT',
                amountSwapped: amountToSwap, amountReceived: parseFloat(amountReceived.toFixed(isSwappingUsdtToZsg ? 4 : 2)),
                rateSnapshot: currentZSGValue, swappedAt: serverTimestamp(), status: 'Completed'
            });
            showGenericMessage("Swap successful!", false);
            if(swapModalEl) swapModalEl.style.display = "none";
        } catch (error) {
            console.error("Swap error:", error);
            showGenericMessage("Swap failed: " + error.message, true);
        } finally {
            if (confirmSwapBtnEl) { confirmSwapBtnEl.disabled = false; confirmSwapBtnEl.innerHTML = originalButtonText; }
        }
    }
    if (confirmSwapBtnEl) confirmSwapBtnEl.onclick = handleSwap;

  </script>
</body>
</html>
