<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GainX Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #e5e7eb; }
        .tab-button { transition: background-color 0.2s, color 0.2s; }
        .tab-button.active { background-color: #3b82f6; color: white; }
        .tab-button:not(.active):hover { background-color: #374151; }
        .table th, .table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #374151; }
        .table th { background-color: #1f2937; font-weight: 600; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center;}
        .modal-content { background-color: #1f2937; margin: auto; padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 500px; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-content-lg { max-width: 700px; } /* For larger modals like user edit */
        .modal-close-btn { position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; font-weight: bold; cursor: pointer; color: #9ca3af; }
        .modal-close-btn:hover { color: #e5e7eb; }
        .input-field, .select-field, .textarea-field { background-color: #374151; border: 1px solid #4b5563; color: #e5e7eb; padding: 0.5rem 0.75rem; border-radius: 0.375rem; width: 100%; }
        .input-field:focus, .select-field:focus, .textarea-field:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 2px rgba(59,130,246,0.3); }
        .input-field[readonly] { background-color: #2b3646; cursor: not-allowed; }
        .checkbox-label { display: flex; align-items: center; margin-top: 0.5rem; font-size: 0.9rem; color: #d1d5db;}
        .checkbox-input { width: 1rem; height: 1rem; margin-right: 0.5rem; accent-color: #3b82f6; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.875rem; }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #4b5563; color: white; }
        .btn-secondary:hover { background-color: #6b7280; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .section-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; color: #f3f4f6; }
        .card { background-color: #1f2937; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .loading-spinner {
            border: 4px solid #4b5563;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        .status-active { background-color: #22c55e; } /* green-500 */
        .status-blocked { background-color: #ef4444; } /* red-500 */
        .status-notice { background-color: #eab308; } /* yellow-500 */
        .status-verified { background-color: #3b82f6; } /* blue-500 */
        .actions-cell button { margin-right: 0.25rem; margin-bottom: 0.25rem;}
        .actions-cell button:last-child { margin-right: 0; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="container mx-auto max-w-6xl">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-sky-400">Gain<span class="text-gray-50">X</span> Admin Panel</h1>
        </header>

        <div class="mb-6 flex flex-wrap justify-center gap-2 border-b border-gray-700 pb-2">
            <button class="tab-button px-4 py-2 rounded-md active" data-tab="globalSettings">Global Settings</button>
            <button class="tab-button px-4 py-2 rounded-md" data-tab="userManagement">User Management</button>
            <button class="tab-button px-4 py-2 rounded-md" data-tab="withdrawalRequests">Withdrawal Requests</button>
            <button class="tab-button px-4 py-2 rounded-md" data-tab="swapRequests">Swap Requests</button>
        </div>

        <div id="tabContent">
            <div id="globalSettings" class="tab-pane active space-y-6">
                <div class="card">
                    <h3 class="section-title">Conversion Rates & Token Value</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="usdtInrRate" class="block text-sm font-medium text-gray-300 mb-1">USDT to INR Rate:</label>
                            <input type="number" id="usdtInrRate" class="input-field" step="0.01">
                            <button id="updateUsdtInrRateBtn" class="btn btn-primary mt-2">Update INR Rate</button>
                        </div>
                        <div>
                            <label for="zsgTokenValue" class="block text-sm font-medium text-gray-300 mb-1">ZSG Token Value (in USDT):</label>
                            <input type="number" id="zsgTokenValue" class="input-field" step="0.0001">
                            <button id="updateZsgTokenValueBtn" class="btn btn-primary mt-2">Update ZSG Value</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="section-title">App Settings</h3>
                    <div>
                        <label for="maintenanceMessage" class="block text-sm font-medium text-gray-300 mb-1">Maintenance Message:</label>
                        <textarea id="maintenanceMessage" class="textarea-field h-24" placeholder="Enter maintenance message..."></textarea>
                        <button id="updateMaintenanceMsgBtn" class="btn btn-primary mt-2">Update Message</button>
                    </div>
                </div>
            </div>

            <div id="userManagement" class="tab-pane hidden">
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="section-title mb-0">Users</h3>
                        <button id="openAddUserModalBtn" class="btn btn-primary">Add New User</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="table w-full min-w-full">
                            <thead>
                                <tr><th>User ID</th><th>Email</th><th>USDT</th><th>ZSG</th><th>Role</th><th>Status</th><th>Actions</th></tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr><td colspan="7" class="text-center py-4"><div class="loading-spinner"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="withdrawalRequests" class="tab-pane hidden">
                 <div class="card">
                    <h3 class="section-title">Withdrawal Requests</h3>
                    <div class="overflow-x-auto">
                        <table class="table w-full min-w-full">
                            <thead>
                                <tr><th>Req ID</th><th>User ID</th><th>Amount</th><th>Currency</th><th>Method</th><th>Status</th><th>Date</th><th>Actions</th></tr>
                            </thead>
                            <tbody id="withdrawalRequestsTableBody">
                                <tr><td colspan="8" class="text-center py-4"><div class="loading-spinner"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="swapRequests" class="tab-pane hidden">
                <div class="card">
                    <h3 class="section-title">Swap Requests</h3>
                     <div class="overflow-x-auto">
                        <table class="table w-full min-w-full">
                            <thead>
                                <tr><th>Req ID</th><th>User ID</th><th>From</th><th>Amount Swapped</th><th>To</th><th>Amount Received</th><th>Rate</th><th>Date</th><th>Status</th><th>Actions</th></tr>
                            </thead>
                            <tbody id="swapRequestsTableBody">
                                <tr><td colspan="10" class="text-center py-4"><div class="loading-spinner"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="userEditModal" class="modal">
        <div class="modal-content modal-content-lg">
            <span class="modal-close-btn" id="closeUserEditModalBtn">&times;</span>
            <h3 class="section-title mb-4">Edit User Controls & Balances</h3>
            <div>
                <label for="currentUserIdDisplay" class="block text-sm font-medium text-gray-400">Current User ID:</label>
                <input type="text" id="currentUserIdDisplay" class="input-field mb-2 bg-gray-700 cursor-not-allowed" readonly>
            </div>
            <div>
                <label for="editNewUserId" class="block text-sm font-medium text-gray-300">New User ID (Optional - leave blank to keep current):</label>
                <input type="text" id="editNewUserId" class="input-field" placeholder="Enter new unique User ID if changing">
                 <p class="text-xs text-yellow-400 mt-1">Warning: Changing User ID only moves this user's data. Other references (e.g., in transactions) will NOT be updated automatically.</p>
            </div>
            <div class="mt-4 space-y-4">
                <div>
                    <label for="editUserEmail" class="block text-sm font-medium text-gray-300">Email:</label>
                    <input type="email" id="editUserEmail" class="input-field">
                </div>
                <div class="form-grid">
                    <div>
                        <label for="editUsdtBalance" class="block text-sm font-medium text-gray-300">USDT Balance:</label>
                        <input type="number" id="editUsdtBalance" class="input-field" step="0.01">
                    </div>
                    <div>
                        <label for="editZsgTokenBalance" class="block text-sm font-medium text-gray-300">ZSG Token Balance (Quantity):</label>
                        <input type="number" id="editZsgTokenBalance" class="input-field" step="0.0001">
                    </div>
                     <div>
                        <label for="editWithdrawalAvailable" class="block text-sm font-medium text-gray-300">Withdrawal Available (USDT):</label>
                        <input type="number" id="editWithdrawalAvailable" class="input-field" step="0.01">
                    </div>
                     <div>
                        <label for="editUserRole" class="block text-sm font-medium text-gray-300">User Role:</label>
                        <select id="editUserRole" class="select-field input-field">
                            <option value="standard">Standard</option>
                            <option value="premium">Premium</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div>
                        <label for="editCurrentRoi" class="block text-sm font-medium text-gray-300">Current ROI (%):</label>
                        <input type="number" id="editCurrentRoi" class="input-field" step="0.01" placeholder="e.g., 5.75">
                    </div>
                    <div>
                        <label for="editPlanName" class="block text-sm font-medium text-gray-300">Plan Name:</label>
                        <input type="text" id="editPlanName" class="input-field" placeholder="e.g., Growth Plan">
                    </div>
                    <div>
                        <label for="editSettlementTimestampInput" class="block text-sm font-medium text-gray-300">Settlement Due Date & Time:</label>
                        <input type="datetime-local" id="editSettlementTimestampInput" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300">Time Remaining:</label>
                        <span id="settlementCountdownDisplay" class="text-lg font-semibold text-sky-400">N/A</span>
                    </div>
                </div>
               <div>
                    <label for="editUserDeck" class="block text-sm font-medium text-gray-300">Deck/Description (Optional):</label>
                    <input type="text" id="editUserDeck" class="input-field">
                </div>
                <hr class="border-gray-600 my-4">
                <h4 class="text-lg font-medium text-gray-200">User Controls</h4>
                <div>
                    <label for="editUserNotice" class="block text-sm font-medium text-gray-300">User Notice (Displayed to user if set):</label>
                    <textarea id="editUserNotice" class="textarea-field h-20" placeholder="Enter a notice for the user..."></textarea>
                </div>
                <div class="mt-2">
                    <label for="editBlockReason" class="block text-sm font-medium text-gray-300">Reason for Blocking Account (if access is blocked):</label>
                    <textarea id="editBlockReason" class="textarea-field h-20" placeholder="Enter reason for account block..."></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                    <label class="checkbox-label">
                        <input type="checkbox" id="editIsWithdrawalBlocked" class="checkbox-input">
                        Block Withdrawals
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="editIsAccessBlocked" class="checkbox-input">
                        Block Account Access
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="editIsEmailVerified" class="checkbox-input">
                        Email Verified
                    </label>
                     <label class="checkbox-label">
                        <input type="checkbox" id="editIsApiEnabled" class="checkbox-input">
                        API Access Enabled
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="editForcePasswordReset" class="checkbox-input">
                        Flag for Password Reset
                    </label>
                     <div>
                        <p class="text-sm font-medium text-gray-300">2FA Status: <span id="editTwoFactorStatus" class="font-normal text-gray-400">N/A</span></p>
                        <button type="button" id="flag2FAResetBtn" class="btn btn-secondary btn-sm mt-1">Flag for 2FA Reset</button>
                    </div>
                </div>
                 <div>
                    <label for="editAdminNotes" class="block text-sm font-medium text-gray-300 mt-2">Internal Admin Notes:</label>
                    <textarea id="editAdminNotes" class="textarea-field h-20" placeholder="Internal notes about this user..."></textarea>
                </div>
                <button id="saveUserChangesBtn" class="btn btn-primary w-full mt-4">Update User</button>
            </div>
        </div>
    </div>

    <div id="addUserModal" class="modal">
        <div class="modal-content modal-content-lg">
            <span class="modal-close-btn" id="closeAddUserModalBtn">&times;</span>
            <h3 class="section-title mb-4">Add New User</h3>
            <div class="space-y-4">
                <div>
                    <label for="addUserId" class="block text-sm font-medium text-gray-300">User ID (Unique - e.g., Firebase Auth UID):</label>
                    <input type="text" id="addUserId" class="input-field" placeholder="Enter unique User ID">
                </div>
                <div>
                    <label for="addUserEmail" class="block text-sm font-medium text-gray-300">Email:</label>
                    <input type="email" id="addUserEmail" class="input-field" placeholder="user@example.com">
                </div>
                <div class="form-grid">
                    <div>
                        <label for="addUsdtBalance" class="block text-sm font-medium text-gray-300">Initial USDT Balance:</label>
                        <input type="number" id="addUsdtBalance" class="input-field" step="0.01" value="0">
                    </div>
                    <div>
                        <label for="addZsgTokenBalance" class="block text-sm font-medium text-gray-300">Initial ZSG Token Balance (Quantity):</label>
                        <input type="number" id="addZsgTokenBalance" class="input-field" step="0.0001" value="0">
                    </div>
                     <div>
                        <label for="addWithdrawalAvailable" class="block text-sm font-medium text-gray-300">Initial Withdrawal Available (USDT):</label>
                        <input type="number" id="addWithdrawalAvailable" class="input-field" step="0.01" value="0">
                    </div>
                     <div>
                        <label for="addUserRole" class="block text-sm font-medium text-gray-300">User Role:</label>
                        <select id="addUserRole" class="select-field input-field">
                            <option value="standard" selected>Standard</option>
                            <option value="premium">Premium</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div>
                        <label for="addCurrentRoi" class="block text-sm font-medium text-gray-300">Current ROI (%):</label>
                        <input type="number" id="addCurrentRoi" class="input-field" step="0.01" placeholder="e.g., 5.00 (optional)">
                    </div>
                    <div>
                        <label for="addPlanName" class="block text-sm font-medium text-gray-300">Plan Name:</label>
                        <input type="text" id="addPlanName" class="input-field" placeholder="e.g., Standard Plan (optional)">
                    </div>
                    <div>
                        <label for="addSettlementTimestampInput" class="block text-sm font-medium text-gray-300">Settlement Due Date & Time (Optional):</label>
                        <input type="datetime-local" id="addSettlementTimestampInput" class="input-field">
                    </div>
                </div>
                <div>
                    <label for="addUserDeck" class="block text-sm font-medium text-gray-300">Deck/Description (Optional):</label>
                    <input type="text" id="addUserDeck" class="input-field" placeholder="e.g., New premium user">
                </div>
                <button id="saveNewUserBtn" class="btn btn-primary w-full">Save New User</button>
            </div>
        </div>
    </div>

    <div id="withdrawalStatusModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn" id="closeWithdrawalStatusModalBtn">&times;</span>
            <h3 class="section-title mb-4">Update Withdrawal Status</h3>
            <input type="hidden" id="updateWithdrawalUserId">
            <input type="hidden" id="updateWithdrawalReqId">
            <p class="mb-2">Request ID: <span id="withdrawalReqIdDisplay" class="font-semibold"></span></p>
            <p class="mb-4">User ID: <span id="withdrawalUserIdDisplay" class="font-semibold"></span></p>
            <div>
                <label for="withdrawalNewStatus" class="block text-sm font-medium text-gray-300">New Status:</label>
                <select id="withdrawalNewStatus" class="select-field input-field">
                    <option value="Pending">Pending</option>
                    <option value="Completed">Completed</option>
                    <option value="Failed">Failed</option>
                    <option value="Processing">Processing</option>
                    <option value="Cancelled">Cancelled</option>
                </select>
            </div>
            <button id="confirmWithdrawalStatusUpdateBtn" class="btn btn-primary w-full mt-4">Update Status</button>
        </div>
    </div>

     <div id="adminTransactionDetailModal" class="modal">
        <div class="modal-content modal-content-lg">
            <span class="modal-close-btn" id="closeAdminTransactionDetailModalBtn">&times;</span>
            <h3 id="adminTransactionDetailTitle" class="section-title mb-4">Edit Transaction Details</h3>
            <form id="editTransactionForm" class="space-y-4">
                <input type="hidden" id="editTxUserId">
                <input type="hidden" id="editTxId">
                <input type="hidden" id="editTxType">

                <div class="form-grid">
                    <div>
                        <label for="editTxDetailId" class="block text-sm font-medium text-gray-400">Transaction ID:</label>
                        <input type="text" id="editTxDetailId" class="input-field bg-gray-700 cursor-not-allowed" readonly>
                    </div>
                    <div>
                        <label for="editTxDetailUserId" class="block text-sm font-medium text-gray-400">User ID:</label>
                        <input type="text" id="editTxDetailUserId" class="input-field bg-gray-700 cursor-not-allowed" readonly>
                    </div>
                </div>
                <div id="editTxFieldsContainer">
                    </div>
                 <div>
                    <label for="editTxStatus" class="block text-sm font-medium text-gray-300">Status:</label>
                    <select id="editTxStatus" class="select-field input-field">
                        <option value="Pending">Pending</option>
                        <option value="Completed">Completed</option>
                        <option value="Failed">Failed</option>
                        <option value="Processing">Processing</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>
                <p class="text-sm text-red-500 mt-1 font-semibold">Warning: Editing historical financial data can severely impact data integrity and user balances. Double-check all values. Proceed with extreme caution.</p>
                <button type="button" id="updateTransactionDetailsBtn" class="btn btn-primary w-full">Update Transaction</button>
            </form>
        </div>
    </div>

    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn" id="closeConfirmationModalBtn">&times;</span>
            <h3 class="section-title mb-4">Confirm Action</h3>
            <p id="confirmationMessage" class="mb-6 text-gray-300">Are you sure you want to proceed with this action?</p>
            <div class="flex justify-end gap-3">
                <button id="cancelConfirmBtn" class="btn btn-secondary">Cancel</button>
                <button id="confirmActionBtn" class="btn btn-danger">Confirm</button>
            </div>
        </div>
    </div>

    <div id="adminNotificationArea" class="fixed bottom-5 right-5 z-50">
        </div>


    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, get, set, update, remove, serverTimestamp, query, orderByChild } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";

        // --- Notification System ---
        const adminNotificationArea = document.getElementById('adminNotificationArea');
        function showAdminNotification(message, isError = false) {
            if (!adminNotificationArea) {
                console.error("Admin Notification Area not found in DOM. Message:", message);
                return;
            }
            const notifId = 'notif-' + Date.now();
            const notifDiv = document.createElement('div');
            notifDiv.id = notifId;
            notifDiv.className = `p-4 mb-2 rounded-md shadow-lg text-white ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            notifDiv.textContent = message;
            adminNotificationArea.appendChild(notifDiv);
            setTimeout(() => {
                const el = document.getElementById(notifId);
                if (el) el.remove();
            }, 5000);
        }
        
        const firebaseConfigDataEl = document.getElementById('firebase-config-data');
        let firebaseConfig;
        if (firebaseConfigDataEl) {
            try {
                firebaseConfig = JSON.parse(firebaseConfigDataEl.textContent);
            } catch (e) {
                console.error("Admin Panel: Failed to parse Firebase config from script tag.", e);
                showAdminNotification("Critical: Firebase configuration is invalid. Panel cannot initialize.", true);
            }
        } else {
            console.error("Admin Panel: Firebase config script tag not found.");
            showAdminNotification("Critical: Firebase configuration missing. Panel cannot initialize.", true);
        }


        // Initialize Firebase
        let app;
        let database;
        if (firebaseConfig && firebaseConfig.databaseURL) { // Check if config and databaseURL exist
            try {
                app = initializeApp(firebaseConfig);
                database = getDatabase(app);
                console.log("Admin Panel: Firebase initialized successfully.");
            } catch (error) {
                console.error("Admin Panel: Firebase initialization error:", error);
                showAdminNotification(`Critical: Firebase failed to initialize. Error: ${error.message}. Admin panel may not work. Check console for details.`, true);
            }
        } else if (firebaseConfig && !firebaseConfig.databaseURL) {
             console.error("Admin Panel: Firebase config is missing 'databaseURL'.");
             showAdminNotification("Critical: Firebase config is missing 'databaseURL'. Panel cannot initialize.", true);
        }


        // --- Tab Navigation ---
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanes = document.querySelectorAll('.tab-pane');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const targetTab = button.dataset.tab;
                tabPanes.forEach(pane => {
                    if (pane.id === targetTab) {
                        pane.classList.remove('hidden');
                        pane.classList.add('active');
                    } else {
                        pane.classList.add('hidden');
                        pane.classList.remove('active');
                    }
                });
                if (database) { // Only load data if Firebase is initialized
                    if (targetTab === 'globalSettings') loadGlobalSettings();
                    if (targetTab === 'userManagement') loadUsers();
                    if (targetTab === 'withdrawalRequests') loadWithdrawalRequests();
                    if (targetTab === 'swapRequests') loadSwapRequests();
                } else {
                    showAdminNotification("Firebase not initialized. Cannot load tab data.", true);
                }
            });
        });
        
        // --- Modal Handling (Generic Setup) ---
        let settlementCountdownInterval = null; // For managing the settlement countdown

        function setupModal(modalId, openBtnId, closeBtnId) {
            const modal = document.getElementById(modalId);
            const openBtn = document.getElementById(openBtnId);
            const closeBtn = document.getElementById(closeBtnId);

            if (openBtn && modal) openBtn.addEventListener('click', () => modal.style.display = "flex");
            
            if (closeBtn && modal) {
                closeBtn.addEventListener('click', () => {
                    modal.style.display = "none";
                    if (modalId === 'userEditModal' && settlementCountdownInterval) {
                        clearInterval(settlementCountdownInterval);
                        settlementCountdownInterval = null;
                        const countdownDisplay = document.getElementById('settlementCountdownDisplay');
                        if(countdownDisplay) countdownDisplay.textContent = "N/A"; // Reset display
                    }
                });
            }
            if (modal) { // Click outside to close
                 window.addEventListener('click', (event) => {
                     if (event.target == modal) {
                        modal.style.display = "none";
                        if (modalId === 'userEditModal' && settlementCountdownInterval) {
                            clearInterval(settlementCountdownInterval);
                            settlementCountdownInterval = null;
                            const countdownDisplay = document.getElementById('settlementCountdownDisplay');
                            if(countdownDisplay) countdownDisplay.textContent = "N/A"; // Reset display
                        }
                     }
                 });
            }
        }
        setupModal('userEditModal', null, 'closeUserEditModalBtn'); // Open is handled by table row buttons
        setupModal('addUserModal', 'openAddUserModalBtn', 'closeAddUserModalBtn');
        setupModal('withdrawalStatusModal', null, 'closeWithdrawalStatusModalBtn'); // Open is handled by table row buttons
        setupModal('adminTransactionDetailModal', null, 'closeAdminTransactionDetailModalBtn'); // Open is handled by table row buttons
        setupModal('confirmationModal', null, 'closeConfirmationModalBtn'); // Opened programmatically

        // --- Confirmation Modal Logic ---
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationMessageEl = document.getElementById('confirmationMessage');
        const confirmActionBtn = document.getElementById('confirmActionBtn');
        const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
        const closeConfirmationModalBtn = document.getElementById('closeConfirmationModalBtn'); // Ensure this is also handled

        let currentConfirmCallback = null;

        function openConfirmationModal(message, onConfirmCallback) {
            confirmationMessageEl.textContent = message;
            currentConfirmCallback = onConfirmCallback;
            confirmationModal.style.display = "flex";
        }

        confirmActionBtn.addEventListener('click', () => {
            if (currentConfirmCallback) {
                currentConfirmCallback();
            }
            confirmationModal.style.display = "none";
            currentConfirmCallback = null;
        });

        cancelConfirmBtn.addEventListener('click', () => {
            confirmationModal.style.display = "none";
            currentConfirmCallback = null;
        });
         closeConfirmationModalBtn.addEventListener('click', () => { // Also handle the 'x' button
            confirmationModal.style.display = "none";
            currentConfirmCallback = null;
        });


        // --- Global Settings ---
        const usdtInrRateInput = document.getElementById('usdtInrRate');
        const updateUsdtInrRateBtn = document.getElementById('updateUsdtInrRateBtn');
        const zsgTokenValueInput = document.getElementById('zsgTokenValue');
        const updateZsgTokenValueBtn = document.getElementById('updateZsgTokenValueBtn');
        const maintenanceMessageInput = document.getElementById('maintenanceMessage');
        const updateMaintenanceMsgBtn = document.getElementById('updateMaintenanceMsgBtn');

        async function loadGlobalSettings() {
            if (!database) { showAdminNotification("Firebase not initialized. Cannot load settings.", true); return; }
            try {
                const inrRateSnapshot = await get(ref(database, 'globals/conversionRates/USDT_INR'));
                if (inrRateSnapshot.exists()) usdtInrRateInput.value = inrRateSnapshot.val();

                const zsgValueSnapshot = await get(ref(database, 'tokenInfo/currentValue'));
                if (zsgValueSnapshot.exists()) zsgTokenValueInput.value = zsgValueSnapshot.val();
                
                const maintenanceMsgSnapshot = await get(ref(database, 'app_settings/maintenanceMessage'));
                if (maintenanceMsgSnapshot.exists()) maintenanceMessageInput.value = maintenanceMsgSnapshot.val();
            } catch (error) {
                console.error("Error loading global settings:", error);
                showAdminNotification("Error loading global settings.", true);
            }
        }

        updateUsdtInrRateBtn.addEventListener('click', async () => {
            if (!database) { showAdminNotification("Firebase not initialized.", true); return; }
            const newRate = parseFloat(usdtInrRateInput.value);
            if (isNaN(newRate) || newRate <= 0) {
                showAdminNotification("Invalid INR rate. Must be a positive number.", true); return;
            }
            try {
                await set(ref(database, 'globals/conversionRates/USDT_INR'), newRate);
                showAdminNotification("USDT to INR rate updated successfully.");
            } catch (error) {
                console.error("Error updating INR rate:", error);
                showAdminNotification("Failed to update INR rate.", true);
            }
        });

        updateZsgTokenValueBtn.addEventListener('click', async () => {
            if (!database) { showAdminNotification("Firebase not initialized.", true); return; }
            const newValue = parseFloat(zsgTokenValueInput.value);
            if (isNaN(newValue) || newValue <= 0) {
                showAdminNotification("Invalid ZSG token value. Must be a positive number.", true); return;
            }
            try {
                await set(ref(database, 'tokenInfo/currentValue'), newValue);
                showAdminNotification("ZSG token value updated successfully.");
            } catch (error) {
                console.error("Error updating ZSG value:", error);
                showAdminNotification("Failed to update ZSG value.", true);
            }
        });
        
        updateMaintenanceMsgBtn.addEventListener('click', async () => {
            if (!database) { showAdminNotification("Firebase not initialized.", true); return; }
            const newMessage = maintenanceMessageInput.value.trim();
            try {
                await set(ref(database, 'app_settings/maintenanceMessage'), newMessage);
                showAdminNotification("Maintenance message updated successfully.");
            } catch (error) {
                console.error("Error updating maintenance message:", error);
                showAdminNotification("Failed to update maintenance message.", true);
            }
        });

        // --- User Management ---
        const usersTableBody = document.getElementById('usersTableBody');
        const userEditModal = document.getElementById('userEditModal');
        const currentUserIdDisplayInput = document.getElementById('currentUserIdDisplay');
        const editNewUserIdInput = document.getElementById('editNewUserId');
        const editUserEmailInput = document.getElementById('editUserEmail');
        const editUsdtBalanceInput = document.getElementById('editUsdtBalance');
        const editZsgTokenBalanceInput = document.getElementById('editZsgTokenBalance');
        const editWithdrawalAvailableInput = document.getElementById('editWithdrawalAvailable');
        const editUserDeckInput = document.getElementById('editUserDeck');
        const editUserNoticeInput = document.getElementById('editUserNotice');
        const editBlockReasonTextarea = document.getElementById('editBlockReason');
        const editIsWithdrawalBlockedCheckbox = document.getElementById('editIsWithdrawalBlocked');
        const editIsAccessBlockedCheckbox = document.getElementById('editIsAccessBlocked');
        const editUserRoleSelect = document.getElementById('editUserRole');
        const editIsEmailVerifiedCheckbox = document.getElementById('editIsEmailVerified');
        const editIsApiEnabledCheckbox = document.getElementById('editIsApiEnabled');
        const editForcePasswordResetCheckbox = document.getElementById('editForcePasswordReset');
        const editTwoFactorStatusSpan = document.getElementById('editTwoFactorStatus');
        const flag2FAResetBtn = document.getElementById('flag2FAResetBtn');
        const editAdminNotesTextarea = document.getElementById('editAdminNotes');
        const saveUserChangesBtn = document.getElementById('saveUserChangesBtn');
        const editCurrentRoiInput = document.getElementById('editCurrentRoi');
        const editPlanNameInput = document.getElementById('editPlanName');
        const editSettlementTimestampInput = document.getElementById('editSettlementTimestampInput');
        const settlementCountdownDisplay = document.getElementById('settlementCountdownDisplay');


        const addUserModal = document.getElementById('addUserModal');
        const addUserIdInput = document.getElementById('addUserId');
        const addUserEmailInput = document.getElementById('addUserEmail');
        const addUsdtBalanceInput = document.getElementById('addUsdtBalance');
        const addZsgTokenBalanceInput = document.getElementById('addZsgTokenBalance');
        const addWithdrawalAvailableInput = document.getElementById('addWithdrawalAvailable');
        const addUserDeckInput = document.getElementById('addUserDeck');
        const addUserRoleSelect = document.getElementById('addUserRole');
        const saveNewUserBtn = document.getElementById('saveNewUserBtn');
        const openAddUserModalBtn = document.getElementById('openAddUserModalBtn');
        const addCurrentRoiInput = document.getElementById('addCurrentRoi');
        const addPlanNameInput = document.getElementById('addPlanName');
        const addSettlementTimestampInput = document.getElementById('addSettlementTimestampInput');


        if(openAddUserModalBtn) {
            openAddUserModalBtn.addEventListener('click', () => {
                 if(addUserModal) {
                     addUserIdInput.value = '';
                     addUserEmailInput.value = '';
                     addUsdtBalanceInput.value = '0';
                     addZsgTokenBalanceInput.value = '0';
                     addWithdrawalAvailableInput.value = '0';
                     addUserDeckInput.value = '';
                     addUserRoleSelect.value = 'standard';
                     addCurrentRoiInput.value = '';
                     addPlanNameInput.value = '';
                     addSettlementTimestampInput.value = ''; // Clear new settlement time input
                     addUserModal.style.display = "flex";
                 }
            });
        }

        function updateSettlementCountdownDisplay(targetTimestamp, displayElementId) {
            const displayElement = document.getElementById(displayElementId);
            if (!displayElement) return;

            if (settlementCountdownInterval) {
                clearInterval(settlementCountdownInterval); // Clear existing interval
                settlementCountdownInterval = null;
            }

            if (!targetTimestamp || typeof targetTimestamp !== 'number' || targetTimestamp <= Date.now()) {
                displayElement.textContent = (targetTimestamp && typeof targetTimestamp === 'number' && targetTimestamp <= Date.now()) ? "Settled" : "N/A";
                // Optionally clear the datetime input if settled and it's the edit modal
                if (displayElementId === 'settlementCountdownDisplay' && targetTimestamp && targetTimestamp <= Date.now()) {
                    // document.getElementById('editSettlementTimestampInput').value = ''; // Decide if this is desired UX
                }
                return;
            }

            const update = () => {
                const now = Date.now();
                const timeLeft = targetTimestamp - now;

                if (timeLeft <= 0) {
                    displayElement.textContent = "Settled";
                    clearInterval(settlementCountdownInterval);
                    settlementCountdownInterval = null;
                    // Optionally clear the datetime input
                    // if (displayElementId === 'settlementCountdownDisplay') {
                    // document.getElementById('editSettlementTimestampInput').value = '';
                    // }
                    return;
                }

                const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

                displayElement.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
            };

            update(); // Initial call
            settlementCountdownInterval = setInterval(update, 1000);
        }


        async function loadUsers() {
            if (!database) { showAdminNotification("Firebase not initialized. Cannot load users.", true); return; }
            usersTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4"><div class="loading-spinner"></div></td></tr>';
            try {
                const usersSnapshot = await get(ref(database, 'users'));
                usersTableBody.innerHTML = '';
                if (usersSnapshot.exists()) {
                    usersSnapshot.forEach(userSnap => {
                        const userId = userSnap.key;
                        const userData = userSnap.val();
                        const row = usersTableBody.insertRow();
                        
                        let statusIcons = '';
                        if (userData.isAccessBlocked) {
                            statusIcons += `<span class="status-indicator status-blocked" title="Access Blocked${userData.blockReason ? ': ' + userData.blockReason : ''}"></span>`;
                        } else if (userData.isWithdrawalBlocked) {
                            statusIcons += '<span class="status-indicator status-blocked" title="Withdrawals Blocked"></span>';
                        } else {
                            statusIcons += '<span class="status-indicator status-active" title="Active"></span>';
                        }
                        if (userData.userNotice && userData.userNotice.trim() !== '') {
                            statusIcons += `<span class="status-indicator status-notice" title="Notice: ${userData.userNotice}"></span>`;
                        }
                        if (userData.isEmailVerified) {
                            statusIcons += `<span class="status-indicator status-verified" title="Email Verified"></span>`;
                        }


                        row.innerHTML = `
                            <td>${userId}</td>
                            <td>${userData.email || 'N/A'}</td>
                            <td>${(userData.usdtBalance || 0).toFixed(2)}</td>
                            <td>${(userData.zsgTokenBalance || 0).toFixed(4)}</td>
                            <td class="capitalize">${userData.role || 'standard'}</td>
                            <td>${statusIcons}</td>
                            <td class="actions-cell">
                                <button class="btn btn-secondary btn-sm edit-user-btn" data-userid="${userId}">Edit</button>
                                <button class="btn btn-danger btn-sm delete-user-btn" data-userid="${userId}">Delete</button>
                            </td>
                        `;
                    });
                    document.querySelectorAll('.edit-user-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => openUserEditModal(e.target.dataset.userid));
                    });
                    document.querySelectorAll('.delete-user-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => handleDeleteUser(e.target.dataset.userid));
                    });
                } else {
                    usersTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No users found.</td></tr>';
                }
            } catch (error) {
                console.error("Error loading users:", error);
                usersTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-red-500">Error loading users.</td></tr>';
                showAdminNotification("Error loading users.", true);
            }
        }

        async function openUserEditModal(userId) {
            if (!database) { showAdminNotification("Firebase not initialized.", true); return; }
            try {
                const userSnapshot = await get(ref(database, `users/${userId}`));
                if (userSnapshot.exists()) {
                    const userData = userSnapshot.val();
                    currentUserIdDisplayInput.value = userId;
                    editNewUserIdInput.value = ""; 
                    editUserEmailInput.value = userData.email || '';
                    editUsdtBalanceInput.value = (userData.usdtBalance || 0).toFixed(2);
                    editZsgTokenBalanceInput.value = (userData.zsgTokenBalance || 0).toFixed(4);
                    editWithdrawalAvailableInput.value = (userData.withdrawalAvailable || 0).toFixed(2);
                    editUserDeckInput.value = userData.Deck || '';
                    editUserNoticeInput.value = userData.userNotice || '';
                    editBlockReasonTextarea.value = userData.blockReason || '';
                    editIsWithdrawalBlockedCheckbox.checked = userData.isWithdrawalBlocked || false;
                    editIsAccessBlockedCheckbox.checked = userData.isAccessBlocked || false;
                    editUserRoleSelect.value = userData.role || 'standard';
                    editIsEmailVerifiedCheckbox.checked = userData.isEmailVerified || false;
                    editIsApiEnabledCheckbox.checked = userData.isApiEnabled || false;
                    editForcePasswordResetCheckbox.checked = userData.forcePasswordReset || false;
                    editTwoFactorStatusSpan.textContent = userData.twoFactorEnabled ? 'Enabled' : (userData.twoFactorResetRequested ? 'Reset Flagged' : 'Disabled');
                    editAdminNotesTextarea.value = userData.adminNotes || '';

                    editCurrentRoiInput.value = (userData.currentROI !== null && userData.currentROI !== undefined) ? userData.currentROI : '';
                    editPlanNameInput.value = userData.planName || '';
                    
                    const settlementTimestamp = userData.settlementTime; // Expecting a numeric timestamp
                    if (settlementTimestamp && typeof settlementTimestamp === 'number') {
                        editSettlementTimestampInput.value = formatTimestampForInput(settlementTimestamp);
                        updateSettlementCountdownDisplay(settlementTimestamp, 'settlementCountdownDisplay');
                    } else {
                        editSettlementTimestampInput.value = ''; // Clear if no valid timestamp
                        updateSettlementCountdownDisplay(null, 'settlementCountdownDisplay'); // Display N/A
                    }

                    userEditModal.style.display = "flex";
                } else {
                    showAdminNotification("User not found.", true);
                }
            } catch (error) {
                console.error("Error fetching user for edit:", error);
                showAdminNotification("Error fetching user data.", true);
            }
        }

        saveUserChangesBtn.addEventListener('click', async () => {
            if (!database) { showAdminNotification("Firebase not initialized.", true); return; }
            
            const currentUserId = currentUserIdDisplayInput.value;
            const newUserIdToUpdateTo = editNewUserIdInput.value.trim();
            
            const userEmail = editUserEmailInput.value.trim();
            const usdtBalance = parseFloat(editUsdtBalanceInput.value);
            const zsgTokenBalance = parseFloat(editZsgTokenBalanceInput.value);
            const withdrawalAvailable = parseFloat(editWithdrawalAvailableInput.value);
            const userDeck = editUserDeckInput.value.trim();
            const userNotice = editUserNoticeInput.value.trim();
            const blockReason = editBlockReasonTextarea.value.trim();
            const isWithdrawalBlocked = editIsWithdrawalBlockedCheckbox.checked;
            const isAccessBlocked = editIsAccessBlockedCheckbox.checked;
            const role = editUserRoleSelect.value;
            const isEmailVerified = editIsEmailVerifiedCheckbox.checked;
            const isApiEnabled = editIsApiEnabledCheckbox.checked;
            const forcePasswordReset = editForcePasswordResetCheckbox.checked;
            const adminNotes = editAdminNotesTextarea.value.trim();
            const currentROIValue = editCurrentRoiInput.value.trim();
            const currentROI = (currentROIValue === '') ? null : parseFloat(currentROIValue);
            const planName = editPlanNameInput.value.trim();
            
            const settlementTimestampStr = editSettlementTimestampInput.value;
            let settlementTime = null; 
            if (settlementTimestampStr) {
                const parsedDate = new Date(settlementTimestampStr);
                if (!isNaN(parsedDate.getTime())) {
                    settlementTime = parsedDate.getTime(); 
                } else {
                    showAdminNotification("Invalid settlement date/time format.", true);
                    // return; // Optional: stop if date is invalid
                }
            }


            if (!userEmail) { 
                showAdminNotification("Email cannot be empty.", true); return;
            }
            if (isNaN(usdtBalance) || isNaN(zsgTokenBalance) || isNaN(withdrawalAvailable)) {
                showAdminNotification("Invalid balance values. Balances must be numbers.", true);
                return;
            }
             if (usdtBalance < 0 || zsgTokenBalance < 0 || withdrawalAvailable < 0) {
                 showAdminNotification("Balances cannot be negative.", true); return;
            }
            if (currentROIValue !== '' && isNaN(currentROI)) {
                 showAdminNotification("Invalid Current ROI. Must be a number or empty.", true); return;
            }


            try {
                let finalUserId = currentUserId;
                let userDataToUpdate;

                const coreUpdates = {
                    email: userEmail,
                    usdtBalance: usdtBalance,
                    zsgTokenBalance: zsgTokenBalance,
                    withdrawalAvailable: withdrawalAvailable,
                    Deck: userDeck,
                    userNotice: userNotice,
                    blockReason: blockReason,
                    isWithdrawalBlocked: isWithdrawalBlocked,
                    isAccessBlocked: isAccessBlocked,
                    role: role,
                    isEmailVerified: isEmailVerified,
                    isApiEnabled: isApiEnabled,
                    forcePasswordReset: forcePasswordReset,
                    adminNotes: adminNotes,
                    currentROI: currentROI,
                    planName: planName,
                    settlementTime: settlementTime // Save numeric timestamp or null
                };

                if (newUserIdToUpdateTo && newUserIdToUpdateTo !== currentUserId) {
                    const newIdSnapshot = await get(ref(database, `users/${newUserIdToUpdateTo}`));
                    if (newIdSnapshot.exists()) {
                        showAdminNotification(`User ID "${newUserIdToUpdateTo}" already exists. Choose a different ID.`, true);
                        return;
                    }

                    const oldUserSnapshot = await get(ref(database, `users/${currentUserId}`));
                    if (!oldUserSnapshot.exists()) {
                        showAdminNotification("Original user data not found. Cannot change ID.", true);
                        return;
                    }
                    userDataToUpdate = { ...oldUserSnapshot.val(), ...coreUpdates };
                    userDataToUpdate.email = userEmail; 
                    userDataToUpdate.currentROI = currentROI;
                    userDataToUpdate.planName = planName;
                    userDataToUpdate.settlementTime = settlementTime;
                    
                    await set(ref(database, `users/${newUserIdToUpdateTo}`), userDataToUpdate);
                    await remove(ref(database, `users/${currentUserId}`));
                    finalUserId = newUserIdToUpdateTo;
                    showAdminNotification(`User ID changed from ${currentUserId} to ${finalUserId} and data updated.`);
                } else {
                    await update(ref(database, `users/${currentUserId}`), coreUpdates);
                    showAdminNotification("User data updated successfully.");
                }
                
                userEditModal.style.display = "none";
                if (settlementCountdownInterval) { // Clear interval when modal closes after save
                    clearInterval(settlementCountdownInterval);
                    settlementCountdownInterval = null;
                }
                loadUsers(); 
            } catch (error) {
                console.error("Error updating user:", error);
                showAdminNotification("Failed to update user. " + error.message, true);
            }
        });
        
        if(flag2FAResetBtn) {
            flag2FAResetBtn.addEventListener('click', async () => {
                if (!database) { showAdminNotification("Firebase not initialized.", true); return; }
                const userId = currentUserIdDisplayInput.value;
                if (!userId) { showAdminNotification("No user selected.", true); return; }

                try {
                    await update(ref(database, `users/${userId}`), {
                        twoFactorResetRequested: true,
                        twoFactorEnabled: false 
                    });
                    showAdminNotification(`2FA reset flagged for user ${userId}. User will need to re-setup 2FA.`);
                    if(editTwoFactorStatusSpan) editTwoFactorStatusSpan.textContent = "Reset Flagged / Disabled";
                } catch (error) {
                     console.error("Error flagging 2FA reset:", error);
                    showAdminNotification("Failed to flag 2FA reset.", true);
                }
            });
        }

        function handleDeleteUser(userId) {
            openConfirmationModal(`Are you sure you want to permanently delete user ${userId}? This action cannot be undone.`, async () => {
                if (!database) { showAdminNotification("Firebase not initialized.", true); return; }
                try {
                    await remove(ref(database, `users/${userId}`));
                    showAdminNotification(`User ${userId} deleted successfully.`);
                    loadUsers(); 
                } catch (error) {
                    console.error("Error deleting user:", error);
                    showAdminNotification(`Failed to delete user ${userId}.`, true);
                }
            });
        }


        saveNewUserBtn.addEventListener('click', async () => {
            if (!database) { showAdminNotification("Firebase not initialized.", true); return; }
            const newUserId = addUserIdInput.value.trim();
            const newUserEmail = addUserEmailInput.value.trim();
            const newUsdtBalance = parseFloat(addUsdtBalanceInput.value);
            const newZsgTokenBalance = parseFloat(addZsgTokenBalanceInput.value);
            const newWithdrawalAvailable = parseFloat(addWithdrawalAvailableInput.value);
            const newUserDeck = addUserDeckInput.value.trim();
            const newUserRole = addUserRoleSelect.value;
            const newCurrentRoiValue = addCurrentRoiInput.value.trim();
            const newCurrentRoi = (newCurrentRoiValue === '') ? null : parseFloat(newCurrentRoiValue);
            const newPlanName = addPlanNameInput.value.trim();
            
            const newSettlementTimestampStr = addSettlementTimestampInput.value;
            let newSettlementTime = null;
            if (newSettlementTimestampStr) {
                const parsedDate = new Date(newSettlementTimestampStr);
                if (!isNaN(parsedDate.getTime())) {
                    newSettlementTime = parsedDate.getTime();
                }
            }

            if (!newUserId) {
                showAdminNotification("User ID is required.", true); return;
            }
            if (!newUserEmail) {
                showAdminNotification("Email is required.", true); return;
            }
            if (isNaN(newUsdtBalance) || isNaN(newZsgTokenBalance) || isNaN(newWithdrawalAvailable)) {
                showAdminNotification("Invalid balance values. Please enter numbers.", true); return;
            }
             if (newUsdtBalance < 0 || newZsgTokenBalance < 0 || newWithdrawalAvailable < 0) {
                 showAdminNotification("Balances cannot be negative.", true); return;
            }
            if (newCurrentRoiValue !== '' && isNaN(newCurrentRoi)) {
                 showAdminNotification("Invalid Current ROI for new user. Must be a number or empty.", true); return;
            }


            try {
                const userSnapshot = await get(ref(database, `users/${newUserId}`));
                if (userSnapshot.exists()) {
                    showAdminNotification("User ID already exists. Please choose a unique ID.", true);
                    return;
                }

                const newUserObject = {
                    email: newUserEmail,
                    usdtBalance: newUsdtBalance,
                    zsgTokenBalance: newZsgTokenBalance,
                    withdrawalAvailable: newWithdrawalAvailable,
                    Deck: newUserDeck || "New user added via admin panel",
                    role: newUserRole,
                    userNotice: "",
                    blockReason: "",
                    isWithdrawalBlocked: false,
                    isAccessBlocked: false,
                    isEmailVerified: false, 
                    isApiEnabled: false,
                    forcePasswordReset: false,
                    twoFactorEnabled: false,
                    twoFactorResetRequested: false,
                    adminNotes: "",
                    bankDetails: { accountNumber: "", fullName: "", ifscCode: "" }, 
                    planOverview: { capitalAllocation: "N/A", currentRoi: "N/A", equityHolder: "N/A", strategyDeployed: "N/A" }, 
                    lastWithdrawal: "N/A",
                    nextWithdrawalSlot: "N/A",
                    createdAt: serverTimestamp(), 
                    currentROI: newCurrentRoi,
                    planName: newPlanName || "N/A", 
                    settlementTime: newSettlementTime // Save numeric timestamp or null
                };

                await set(ref(database, `users/${newUserId}`), newUserObject);
                showAdminNotification(`User ${newUserEmail} (${newUserId}) added successfully.`);
                addUserModal.style.display = "none";
                loadUsers(); 
            } catch (error) {
                console.error("Error adding new user:", error);
                showAdminNotification("Failed to add new user. " + error.message, true);
            }
        });


        // --- Withdrawal Requests Management ---
        const withdrawalRequestsTableBody = document.getElementById('withdrawalRequestsTableBody');
        const withdrawalStatusModal = document.getElementById('withdrawalStatusModal');
        const updateWithdrawalUserIdInput = document.getElementById('updateWithdrawalUserId');
        const updateWithdrawalReqIdInput = document.getElementById('updateWithdrawalReqId');
        const withdrawalReqIdDisplay = document.getElementById('withdrawalReqIdDisplay');
        const withdrawalUserIdDisplay = document.getElementById('withdrawalUserIdDisplay');
        const withdrawalNewStatusSelect = document.getElementById('withdrawalNewStatus');
        const confirmWithdrawalStatusUpdateBtn = document.getElementById('confirmWithdrawalStatusUpdateBtn');

        async function loadWithdrawalRequests() {
            if (!database) { showAdminNotification("Firebase not initialized. Cannot load withdrawals.", true); return; }
            withdrawalRequestsTableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4"><div class="loading-spinner"></div></td></tr>';
            try {
                const requestsSnapshot = await get(ref(database, 'withdrawalRequests'));
                withdrawalRequestsTableBody.innerHTML = '';
                if (requestsSnapshot.exists()) {
                    requestsSnapshot.forEach(userRequestsSnap => {
                        const userId = userRequestsSnap.key;
                        userRequestsSnap.forEach(reqSnap => {
                            const reqId = reqSnap.key;
                            const reqData = reqSnap.val();
                            const row = withdrawalRequestsTableBody.insertRow();
                            row.innerHTML = `
                                <td class="truncate max-w-xs" title="${reqId}">${reqId.substring(0,8)}...</td>
                                <td class="truncate max-w-xs" title="${userId}">${userId.substring(0,8)}...</td>
                                <td>${reqData.amount}</td>
                                <td>${reqData.currency}</td>
                                <td>${reqData.method}</td>
                                <td class="capitalize">${reqData.status}</td>
                                <td>${formatTimestamp(reqData.requestedAt)}</td>
                                <td class="actions-cell">
                                    <button class="btn btn-secondary btn-sm edit-tx-detail-btn" data-txid="${reqId}" data-userid="${userId}" data-txtype="withdrawal">Edit</button>
                                    <button class="btn btn-primary btn-sm update-withdrawal-status-btn" data-userid="${userId}" data-reqid="${reqId}" data-currentstatus="${reqData.status}">Update Status</button>
                                    <button class="btn btn-danger btn-sm delete-withdrawal-btn" data-userid="${userId}" data-reqid="${reqId}">Delete</button>
                                </td>
                            `;
                        });
                    });
                    document.querySelectorAll('.update-withdrawal-status-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => openWithdrawalStatusModal(e.target.dataset.userid, e.target.dataset.reqid, e.target.dataset.currentstatus));
                    });
                    document.querySelectorAll('.edit-tx-detail-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => openTransactionEditModal(e.target.dataset.userid, e.target.dataset.txid, e.target.dataset.txtype));
                    });
                    document.querySelectorAll('.delete-withdrawal-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => handleDeleteWithdrawal(e.target.dataset.userid, e.target.dataset.reqid));
                    });
                } else {
                    withdrawalRequestsTableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4">No withdrawal requests found.</td></tr>';
                }
            } catch (error) {
                console.error("Error loading withdrawal requests:", error);
                withdrawalRequestsTableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-red-500">Error loading withdrawal requests.</td></tr>';
                showAdminNotification("Error loading withdrawal requests.", true);
            }
        }
        
        function openWithdrawalStatusModal(userId, reqId, currentStatus) {
            updateWithdrawalUserIdInput.value = userId;
            updateWithdrawalReqIdInput.value = reqId;
            withdrawalReqIdDisplay.textContent = reqId;
            withdrawalUserIdDisplay.textContent = userId;
            withdrawalNewStatusSelect.value = currentStatus;
            withdrawalStatusModal.style.display = "flex";
        }

        confirmWithdrawalStatusUpdateBtn.addEventListener('click', async () => {
            if (!database) { showAdminNotification("Firebase not initialized.", true); return; }
            const userId = updateWithdrawalUserIdInput.value;
            const reqId = updateWithdrawalReqIdInput.value;
            const newStatus = withdrawalNewStatusSelect.value;

            try {
                await update(ref(database, `withdrawalRequests/${userId}/${reqId}`), {
                    status: newStatus
                });
                showAdminNotification("Withdrawal status updated successfully.");
                withdrawalStatusModal.style.display = "none";
                loadWithdrawalRequests(); 
            } catch (error) {
                console.error("Error updating withdrawal status:", error);
                showAdminNotification("Failed to update withdrawal status.", true);
            }
        });

        function handleDeleteWithdrawal(userId, reqId) {
            openConfirmationModal(`Are you sure you want to delete withdrawal request ${reqId} for user ${userId}?`, async () => {
                if (!database) { showAdminNotification("Firebase not initialized.", true); return; }
                try {
                    await remove(ref(database, `withdrawalRequests/${userId}/${reqId}`));
                    showAdminNotification(`Withdrawal request ${reqId} deleted successfully.`);
                    loadWithdrawalRequests(); 
                } catch (error) {
                    console.error("Error deleting withdrawal request:", error);
                    showAdminNotification(`Failed to delete withdrawal request ${reqId}.`, true);
                }
            });
        }


        // --- Swap Requests Management ---
        const swapRequestsTableBody = document.getElementById('swapRequestsTableBody');
        async function loadSwapRequests() {
            if (!database) { showAdminNotification("Firebase not initialized. Cannot load swaps.", true); return; }
            swapRequestsTableBody.innerHTML = '<tr><td colspan="10" class="text-center py-4"><div class="loading-spinner"></div></td></tr>';
            try {
                const requestsSnapshot = await get(ref(database, 'swapRequests'));
                swapRequestsTableBody.innerHTML = '';
                if (requestsSnapshot.exists()) {
                    requestsSnapshot.forEach(userRequestsSnap => {
                        const userId = userRequestsSnap.key;
                        userRequestsSnap.forEach(reqSnap => {
                            const reqId = reqSnap.key;
                            const reqData = reqSnap.val();
                            const row = swapRequestsTableBody.insertRow();
                            row.innerHTML = `
                                <td class="truncate max-w-xs" title="${reqId}">${reqId.substring(0,8)}...</td>
                                <td class="truncate max-w-xs" title="${userId}">${userId.substring(0,8)}...</td>
                                <td>${reqData.fromCurrency}</td>
                                <td>${parseFloat(reqData.amountSwapped).toFixed(reqData.fromCurrency === 'USDT' ? 2 : 4)}</td>
                                <td>${reqData.toCurrency}</td>
                                <td>${parseFloat(reqData.amountReceived).toFixed(reqData.toCurrency === 'USDT' ? 2 : 4)}</td>
                                <td>${reqData.rateSnapshot}</td>
                                <td>${formatTimestamp(reqData.swappedAt)}</td>
                                <td class="capitalize">${reqData.status}</td>
                                <td class="actions-cell">
                                    <button class="btn btn-secondary btn-sm edit-tx-detail-btn" data-txid="${reqId}" data-userid="${userId}" data-txtype="swap">Edit</button>
                                    <button class="btn btn-danger btn-sm delete-swap-btn" data-userid="${userId}" data-reqid="${reqId}">Delete</button>
                                </td>
                            `;
                        });
                    });
                     document.querySelectorAll('.edit-tx-detail-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => openTransactionEditModal(e.target.dataset.userid, e.target.dataset.txid, e.target.dataset.txtype));
                    });
                    document.querySelectorAll('.delete-swap-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => handleDeleteSwap(e.target.dataset.userid, e.target.dataset.reqid));
                    });
                } else {
                    swapRequestsTableBody.innerHTML = '<tr><td colspan="10" class="text-center py-4">No swap requests found.</td></tr>';
                }
            } catch (error) {
                console.error("Error loading swap requests:", error);
                swapRequestsTableBody.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-red-500">Error loading swap requests.</td></tr>';
                showAdminNotification("Error loading swap requests.", true);
            }
        }
        
        function handleDeleteSwap(userId, reqId) {
            openConfirmationModal(`Are you sure you want to delete swap request ${reqId} for user ${userId}?`, async () => {
                if (!database) { showAdminNotification("Firebase not initialized.", true); return; }
                try {
                    await remove(ref(database, `swapRequests/${userId}/${reqId}`));
                    showAdminNotification(`Swap request ${reqId} deleted successfully.`);
                    loadSwapRequests(); 
                } catch (error) {
                    console.error("Error deleting swap request:", error);
                    showAdminNotification(`Failed to delete swap request ${reqId}.`, true);
                }
            });
        }
        
        // --- Transaction Detail Modal Logic (Now Edit Modal) ---
        const adminTransactionDetailModal = document.getElementById('adminTransactionDetailModal');
        const adminTransactionDetailTitle = document.getElementById('adminTransactionDetailTitle');
        const editTransactionForm = document.getElementById('editTransactionForm'); 
        const editTxFieldsContainer = document.getElementById('editTxFieldsContainer');
        const updateTransactionDetailsBtn = document.getElementById('updateTransactionDetailsBtn');

        async function openTransactionEditModal(userId, txId, txType) {
            if (!database) { showAdminNotification("Firebase not initialized.", true); return; }
            
            document.getElementById('editTxUserId').value = userId;
            document.getElementById('editTxId').value = txId;
            document.getElementById('editTxType').value = txType;

            let path = '';
            if (txType === 'withdrawal') path = `withdrawalRequests/${userId}/${txId}`;
            else if (txType === 'swap') path = `swapRequests/${userId}/${txId}`;
            else { showAdminNotification("Unknown transaction type for edit.", true); return; }

            try {
                const snapshot = await get(ref(database, path));
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    adminTransactionDetailTitle.textContent = `Edit ${txType.charAt(0).toUpperCase() + txType.slice(1)} Details`;
                    document.getElementById('editTxDetailId').value = txId; 
                    document.getElementById('editTxDetailUserId').value = userId; 
                    
                    let fieldsHtml = '<div class="form-grid">';
                    const originalTimestamp = txType === 'withdrawal' ? data.requestedAt : data.swappedAt;

                    fieldsHtml += `
                        <div>
                            <label for="editTxTimestamp" class="block text-sm font-medium text-gray-300">Date & Time:</label>
                            <input type="datetime-local" id="editTxTimestamp" class="input-field" value="${formatTimestampForInput(originalTimestamp)}">
                        </div>
                    `;

                    if (txType === 'withdrawal') {
                        fieldsHtml += `
                            <div><label for="editTxAmountW" class="block text-sm font-medium text-gray-300">Amount (${data.currency}):</label><input type="number" id="editTxAmountW" class="input-field" value="${data.amount || 0}" step="0.01"></div>
                            <div><label class="block text-sm font-medium text-gray-400">Method:</label><input type="text" value="${data.method}" class="input-field bg-gray-700 cursor-not-allowed" readonly></div>
                        `;
                        if (data.method === 'IMPS/NEFT') {
                            fieldsHtml += `
                                <div><label for="editTxFullName" class="block text-sm font-medium text-gray-300">Full Name:</label><input type="text" id="editTxFullName" class="input-field" value="${data.fullName || ''}"></div>
                                <div><label for="editTxIfscCode" class="block text-sm font-medium text-gray-300">IFSC Code:</label><input type="text" id="editTxIfscCode" class="input-field" value="${data.ifscCode || ''}"></div>
                                <div><label for="editTxAccountNumber" class="block text-sm font-medium text-gray-300">Account Number:</label><input type="text" id="editTxAccountNumber" class="input-field" value="${data.accountNumber || ''}"></div>
                                <div><label for="editTxUsdtDeducted" class="block text-sm font-medium text-gray-300">USDT Deducted:</label><input type="number" id="editTxUsdtDeducted" value="${data.usdtEquivalentDeducted?.toFixed(2) || '0.00'}" class="input-field" step="0.01"></div>
                                <div><label for="editTxConversionRate" class="block text-sm font-medium text-gray-300">Rate (USDT/${data.currency === 'INR' ? 'INR' : 'USDT'}):</label><input type="number" id="editTxConversionRate" value="${data.conversionRateSnapshot || '0.00'}" class="input-field" step="0.0001"></div>
                            `;
                        } else if (data.method === 'USDT') {
                            fieldsHtml += `<div><label for="editTxUsdtAddress" class="block text-sm font-medium text-gray-300">To Address:</label><input type="text" id="editTxUsdtAddress" class="input-field" value="${data.usdtAddress || ''}"></div>`;
                        }
                    } else if (txType === 'swap') {
                         fieldsHtml += `
                            <div><label for="editTxAmountSwapped" class="block text-sm font-medium text-gray-300">Amount Swapped (${data.fromCurrency}):</label><input type="number" id="editTxAmountSwapped" class="input-field" value="${parseFloat(data.amountSwapped || 0)}" step="any"></div>
                            <div><label class="block text-sm font-medium text-gray-400">From Currency:</label><input type="text" value="${data.fromCurrency}" class="input-field bg-gray-700 cursor-not-allowed" readonly></div>
                            <div><label for="editTxAmountReceived" class="block text-sm font-medium text-gray-300">Amount Received (${data.toCurrency}):</label><input type="number" id="editTxAmountReceived" class="input-field" value="${parseFloat(data.amountReceived || 0)}" step="any"></div>
                            <div><label class="block text-sm font-medium text-gray-400">To Currency:</label><input type="text" value="${data.toCurrency}" class="input-field bg-gray-700 cursor-not-allowed" readonly></div>
                            <div><label for="editTxRate" class="block text-sm font-medium text-gray-300">Rate (${data.toCurrency} per ${data.fromCurrency}):</label><input type="number" id="editTxRate" class="input-field" value="${data.rateSnapshot || 0}" step="any"></div>
                        `;
                    }
                    fieldsHtml += '</div>'; // Close form-grid
                    editTxFieldsContainer.innerHTML = fieldsHtml;
                    document.getElementById('editTxStatus').value = data.status || 'Pending';
                    adminTransactionDetailModal.style.display = 'flex';
                } else {
                    showAdminNotification("Transaction details not found.", true);
                }
            } catch (error) {
                console.error(`Error fetching ${txType} details for edit:`, error);
                showAdminNotification(`Error fetching ${txType} details.`, true);
            }
        }

        updateTransactionDetailsBtn.addEventListener('click', async () => {
            if (!database) { showAdminNotification("Firebase not initialized.", true); return; }

            const userId = document.getElementById('editTxUserId').value;
            const txId = document.getElementById('editTxId').value;
            const txType = document.getElementById('editTxType').value;
            const newStatus = document.getElementById('editTxStatus').value;
            const newTimestampStr = document.getElementById('editTxTimestamp')?.value; 

            let updates = { status: newStatus };
            let path = '';

            if (newTimestampStr) {
                try {
                    const newDate = new Date(newTimestampStr);
                    if (!isNaN(newDate.getTime())) { 
                        if (txType === 'withdrawal') updates.requestedAt = newDate.getTime();
                        else if (txType === 'swap') updates.swappedAt = newDate.getTime();
                    } else {
                        showAdminNotification("Invalid date/time format provided.", true); return;
                    }
                } catch (e) {
                     showAdminNotification("Error parsing date/time.", true); return;
                }
            }


            if (txType === 'withdrawal') {
                path = `withdrawalRequests/${userId}/${txId}`;
                const amountInput = document.getElementById('editTxAmountW');
                if (amountInput) {
                    const newAmount = parseFloat(amountInput.value);
                    if (!isNaN(newAmount) && newAmount >= 0) updates.amount = newAmount; 
                    else { showAdminNotification("Invalid withdrawal amount. Must be a non-negative number.", true); return; }
                }
                
                const methodSnapshot = await get(ref(database, `${path}/method`)); 
                if (methodSnapshot.exists()) {
                    const method = methodSnapshot.val();
                     if (method === 'IMPS/NEFT') {
                        updates.fullName = document.getElementById('editTxFullName')?.value.trim() || "";
                        updates.ifscCode = document.getElementById('editTxIfscCode')?.value.trim() || "";
                        updates.accountNumber = document.getElementById('editTxAccountNumber')?.value.trim() || "";
                        
                        const usdtDeductedInput = document.getElementById('editTxUsdtDeducted');
                        if (usdtDeductedInput) {
                            const newUsdtDeducted = parseFloat(usdtDeductedInput.value);
                            if(!isNaN(newUsdtDeducted) && newUsdtDeducted >=0) updates.usdtEquivalentDeducted = newUsdtDeducted;
                            else { showAdminNotification("Invalid USDT Deducted amount.", true); return; }
                        }
                        const conversionRateInput = document.getElementById('editTxConversionRate');
                        if (conversionRateInput) {
                            const newConversionRate = parseFloat(conversionRateInput.value);
                            if(!isNaN(newConversionRate) && newConversionRate > 0) updates.conversionRateSnapshot = newConversionRate;
                             else { showAdminNotification("Invalid Conversion Rate.", true); return; }
                        }

                    } else if (method === 'USDT') {
                        updates.usdtAddress = document.getElementById('editTxUsdtAddress')?.value.trim() || "";
                    }
                }

            } else if (txType === 'swap') {
                path = `swapRequests/${userId}/${txId}`;
                const amountSwappedInput = document.getElementById('editTxAmountSwapped');
                if (amountSwappedInput) {
                    const newAmountSwapped = parseFloat(amountSwappedInput.value);
                    if (!isNaN(newAmountSwapped) && newAmountSwapped >= 0) updates.amountSwapped = newAmountSwapped;
                    else { showAdminNotification("Invalid amount swapped. Must be a non-negative number.", true); return; }
                }
                const amountReceivedInput = document.getElementById('editTxAmountReceived');
                if (amountReceivedInput) {
                    const newAmountReceived = parseFloat(amountReceivedInput.value);
                    if (!isNaN(newAmountReceived) && newAmountReceived >= 0) updates.amountReceived = newAmountReceived;
                    else { showAdminNotification("Invalid amount received. Must be a non-negative number.", true); return; }
                }
                const rateInput = document.getElementById('editTxRate');
                if (rateInput) {
                    const newRate = parseFloat(rateInput.value);
                    if (!isNaN(newRate) && newRate > 0) updates.rateSnapshot = newRate;
                    else { showAdminNotification("Invalid rate. Must be a positive number.", true); return; }
                }
            } else {
                showAdminNotification("Unknown transaction type for update.", true); return;
            }

            try {
                await update(ref(database, path), updates);
                showAdminNotification(`${txType.charAt(0).toUpperCase() + txType.slice(1)} details updated successfully.`);
                adminTransactionDetailModal.style.display = "none";
                if (txType === 'withdrawal') loadWithdrawalRequests();
                if (txType === 'swap') loadSwapRequests();
            } catch (error) {
                console.error(`Error updating ${txType} details:`, error);
                showAdminNotification(`Failed to update ${txType} details. Error: ${error.message}`, true);
            }
        });


        // --- Utility Functions ---
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            if (typeof timestamp === 'object' && timestamp.hasOwnProperty('.sv')) return 'Server Timestamp'; 
            try {
                return new Date(timestamp).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' });
            } catch (e) { return 'Invalid Date'; }
        }
        
        function formatTimestampForInput(timestamp) {
            if (!timestamp || (typeof timestamp === 'object' && timestamp.hasOwnProperty('.sv'))) return '';
            try {
                const date = new Date(timestamp);
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            } catch (e) {
                console.error("Error formatting timestamp for input:", e);
                return '';
            }
        }


        // Initial Load
        if (database) {
            loadGlobalSettings();
            const initialActiveTabButton = document.querySelector('.tab-button.active');
            if (initialActiveTabButton) {
                const targetTab = initialActiveTabButton.dataset.tab;
                if (targetTab === 'userManagement') loadUsers();
                else if (targetTab === 'withdrawalRequests') loadWithdrawalRequests();
                else if (targetTab === 'swapRequests') loadSwapRequests();
            }

        } else {
            const globalSettingsPane = document.getElementById('globalSettings');
            if (globalSettingsPane) {
                globalSettingsPane.innerHTML = '<p class="text-red-500 text-center p-4">Firebase connection failed. Please check your configuration and console for errors. Admin panel functionality is disabled.</p>';
            }
            document.getElementById('userManagement').innerHTML = '<p class="text-red-500 text-center p-4">Firebase connection failed.</p>';
            document.getElementById('withdrawalRequests').innerHTML = '<p class="text-red-500 text-center p-4">Firebase connection failed.</p>';
            document.getElementById('swapRequests').innerHTML = '<p class="text-red-500 text-center p-4">Firebase connection failed.</p>';
        }
    </script>
    <script id="firebase-config-data" type="application/json">
    {
      "apiKey": "AIzaSyC9yCEe4a9KC0Ph64gMkrDn_Cfah0TxlMw",
      "authDomain": "swiftgain.firebaseapp.com",
      "databaseURL": "https://swiftgain-default-rtdb.asia-southeast1.firebasedatabase.app",
      "projectId": "swiftgain",
      "storageBucket": "swiftgain.appspot.com",
      "messagingSenderId": "751911092919",
      "appId": "1:751911092919:web:bd0ab90ca8b4432f0d4332"
    }
    </script>
</body>
</html>
